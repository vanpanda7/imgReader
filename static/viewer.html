<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å›¾ç‰‡é˜…è¯»å™¨ - JMComic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .viewer-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* ä¾§è¾¹æ  - å›¾ç‰‡åˆ—è¡¨ */
        .sidebar {
            width: 300px;
            background: #2a2a2a;
            border-right: 1px solid #3a3a3a;
            transition: transform 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }
        
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 15px;
            background: #1a1a1a;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            flex: 1;
        }
        
        .sidebar-header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .sidebar-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .sidebar-btn:active {
            transform: scale(0.95);
        }

        /* æºåˆ‡æ¢ Tabs */
        .source-tabs {
            display: flex;
            padding: 10px 15px;
            background: #222; /* æ¯”èƒŒæ™¯ç¨äº® */
            border-bottom: 1px solid #333;
            gap: 12px;
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 0;
            border-radius: 8px;
            background: #333;
            color: #888;
            border: 1px solid transparent;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            white-space: nowrap;
        }

        /* æ¿€æ´»çŠ¶æ€ï¼šé«˜äº®æ˜¾ç¤º */
        .tab-btn.active {
            background: #667eea;
            color: #fff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }

        .tab-btn:active {
            transform: scale(0.96);
        }

        .sidebar-section-title {
            font-size: 12px;
            color: #aaa;
            padding: 10px 15px 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .toggle-sidebar {
            background: #3a3a3a;
            border: none;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .image-list {
            padding: 0;
            display: none;
        }

        .image-list.has-images {
            display: block;
        }

        .image-item {
            padding: 0;
            margin: 0;
            background: transparent;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }

        .image-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .image-item.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }

        .image-item img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 0;
        }

        .image-item-name {
            display: none;
        }

        /* ä¸»è§†å›¾åŒºåŸŸ */
        .main-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            background: #000;
            min-width: 0; /* é˜²æ­¢ flex å­é¡¹æº¢å‡º */
        }

        .toolbar {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            flex-wrap: wrap;
            gap: 10px;
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .image-counter {
            color: #aaa;
            font-size: 14px;
        }

        .image-viewer {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            background: #000;
            padding: 20px;
            overscroll-behavior: contain; /* é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„æ©¡çš®ç­‹æ•ˆæœ */
            touch-action: pan-y; /* å…è®¸å‚ç›´æ»šåŠ¨ */
        }
        
        .image-wrapper {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 0px;
        }
        
        /* å›¾ç‰‡åŠ è½½æ—¶çš„éª¨æ¶å±åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse {
            0% { background-color: #2a2a2a; }
            50% { background-color: #3a3a3a; }
            100% { background-color: #2a2a2a; }
        }

        .image-wrapper img {
            width: 100%;
            height: auto;
            /* å…³é”®ï¼šç»™æœªåŠ è½½çš„å›¾ç‰‡ä¸€ä¸ªæœ€å°é«˜åº¦ï¼Œé˜²æ­¢æ‰€æœ‰å›¾ç‰‡æŒ¤åœ¨è§†å£å†…å¯¼è‡´ç¬é—´å…¨åŠ è½½ */
            min-height: 300px; 
            display: block;
            object-fit: contain;
            /* é»˜è®¤é€æ˜ï¼ŒåŠ è½½å®Œæˆåé€šè¿‡ .loaded ç±»æ˜¾ç¤ºï¼Œåˆ¶é€ æ·¡å…¥æ•ˆæœ */
            opacity: 0;
            transition: opacity 0.3s ease-in;
            background: #111; /* å ä½èƒŒæ™¯è‰² */
            margin-bottom: 10px;
        }
        
        .image-wrapper img:not(.loaded) {
            /* æœªåŠ è½½å®Œæˆæ—¶åº”ç”¨å‘¼å¸ç¯åŠ¨ç”» */
            animation: pulse 1.5s infinite ease-in-out;
            /* å¯ä»¥åœ¨è¿™é‡Œæ”¾ä¸€ä¸ª loading svg å›¾æ ‡ä½œä¸ºèƒŒæ™¯ */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 50 50'%3E%3Cpath fill='%23667eea' d='M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z'%3E%3CanimateTransform attributeType='xml' attributeName='transform' type='rotate' from='0 25 25' to='360 25 25' dur='0.6s' repeatCount='indefinite'/%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 40px;
        }
        
        .image-wrapper img.loaded {
            opacity: 1;
            min-height: auto; /* åŠ è½½å®Œæˆåå…è®¸è‡ªé€‚åº”é«˜åº¦ */
            background: transparent;
            animation: none; /* åŠ è½½å®Œæˆååœæ­¢åŠ¨ç”» */
        }



        /* åŠ è½½æç¤º */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #aaa;
            font-size: 16px;
        }

        /* å…¨å±æ¨¡å¼ */
        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
        }

        /* æ–‡ä»¶å¤¹æµè§ˆå™¨ */
        .folder-browser {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            /* ä¼˜åŒ–æ»šåŠ¨ä½“éªŒ */
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        
        /* æ–‡ä»¶å¤¹åˆ†é¡µæ§ä»¶ - å·²ç§»é™¤ */
        .folder-pagination {
            display: none !important;
        }
        
        /* ä¸Šæ‹‰åŠ è½½æç¤ºæ¡æ ·å¼ */
        .pull-up-hint {
            height: 0;
            overflow: hidden;
            text-align: center;
            font-size: 12px;
            color: #aaa;
            transition: height 0.2s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            background: rgba(0,0,0,0.2);
        }
        
        .pull-up-hint.visible {
            height: 50px;
            opacity: 1;
        }
        
        .pull-up-hint .icon {
            margin-right: 5px;
            transition: transform 0.3s;
        }
        
        .pull-up-hint.rotate .icon {
            transform: rotate(180deg);
        }

        .breadcrumb-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .breadcrumb-nav {
            font-size: 12px;
            padding: 8px 10px;
            background: rgba(26, 26, 26, 0.6);
            border-radius: 6px;
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 4px;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
            flex: 8;
            min-width: 0;
        }

        .breadcrumb-nav::-webkit-scrollbar {
            height: 4px;
        }

        .breadcrumb-nav::-webkit-scrollbar-track {
            background: transparent;
        }

        .breadcrumb-nav::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 2px;
        }

        .breadcrumb-nav::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }
        
        /* æ’åºæ§ä»¶ */
        .sort-controls {
            flex: 2;
            min-width: 0;
        }
        
        .sort-select {
            width: 100%;
            padding: 4px 6px;
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            color: #fff;
            font-size: 11px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }
        
        .sort-select:hover {
            border-color: #667eea;
            background: #2a2a2a;
        }
        
        .sort-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .breadcrumb-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .breadcrumb-link {
            cursor: pointer;
            color: #667eea;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid transparent;
            font-weight: 500;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }

        .breadcrumb-link:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }

        .breadcrumb-link:active {
            transform: translateY(0);
        }

        .breadcrumb-separator {
            color: #555;
            margin: 0 2px;
            font-size: 10px;
            user-select: none;
            flex-shrink: 0;
        }

        .breadcrumb-current {
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            font-weight: 600;
            cursor: default;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }

        /* æ–‡ä»¶å¤¹åˆ—è¡¨å¸ƒå±€ */
        .folder-list {
            display: grid;
            /* å¼ºåˆ¶æ¯è¡Œ 4 åˆ— */
            grid-template-columns: repeat(4, 1fr);
            /* ç´§å‡‘é—´è· */
            gap: 5px;
            padding: 8px;
        }

        /* æ–‡ä»¶å¤¹å¡ç‰‡æ ·å¼ */
        .folder-item {
            background: #2a2a2a;
            border-radius: 6px;
            padding: 5px; /* ç´§å‡‘å†…è¾¹è· */
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            text-align: center;
            position: relative;
        }

        .folder-item:hover {
            background: #3a3a3a;
            border-color: #667eea; /* hover æ—¶ä¹Ÿæ˜¾ç¤ºè¾¹æ¡†ï¼Œå¢å¼ºåé¦ˆ */
        }

        .folder-item.active {
            border-color: #667eea;
            background: #3a3a3a;
        }
        
        .folder-item:hover .folder-delete-btn {
            opacity: 1;
        }
        
        .folder-delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(220, 53, 69, 0.9);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
            padding: 0;
        }
        
        .folder-delete-btn:hover {
            background: rgba(220, 53, 69, 1);
            transform: scale(1.1);
        }

        /* å°é¢ã€å›¾æ ‡ã€Loading ç»Ÿä¸€æ¯”ä¾‹è°ƒæ•´ */
        .folder-thumbnail, 
        .folder-icon, 
        .folder-loading {
            width: 100%;
            /* ç«–å‘æ¯”ä¾‹ï¼Œé€‚åˆæ¼«ç”» */
            aspect-ratio: 3 / 4; 
            object-fit: cover;
            border-radius: 3px;
            margin-bottom: 4px;
            background: #222;
        }
        
        .folder-thumbnail {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            display: block; /* æ”¹ä¸º blockï¼Œé€šè¿‡ opacity æ§åˆ¶æ˜¾ç¤º */
            opacity: 0;
            transition: opacity 0.3s;
            /* é˜²æ­¢å›¾ç‰‡è¢«é€‰ä¸­ */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            /* é˜²æ­¢å›¾ç‰‡æ‹–æ‹½ */
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            pointer-events: none; /* é˜²æ­¢å›¾ç‰‡æœ¬èº«æ¥æ”¶ç‚¹å‡»äº‹ä»¶ */
        }
        
        .folder-thumbnail.loaded {
            opacity: 1; /* åŠ è½½å®Œæˆåæ˜¾ç¤º */
        }
        
        /* åœ¨æ–‡ä»¶å¤¹é¡¹ä¸Šæ·»åŠ é€æ˜é®ç½©å±‚ï¼Œè¦†ç›–ç¼©ç•¥å›¾åŒºåŸŸ */
        .folder-item::before {
            content: '';
            position: absolute;
            top: 5px; /* ä¸ padding å¯¹é½ */
            left: 5px;
            right: 5px;
            /* ç¼©ç•¥å›¾æ˜¯ç«–å‘æ¯”ä¾‹ï¼ˆaspect-ratio: 3/4ï¼‰ */
            aspect-ratio: 3 / 4;
            border-radius: 3px;
            background: transparent;
            z-index: 1;
            pointer-events: none; /* é®ç½©å±‚ä¸é˜»æŒ¡ç‚¹å‡»äº‹ä»¶ */
            /* é˜²æ­¢é€‰ä¸­ */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(0,0,0,0.5);
            border-radius: 0 0 6px 6px;
        }
        .progress-bar-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s;
        }
        /* å·²è¯»å®Œçš„å˜ç»¿ */
        .progress-bar-fill.finished { 
            background: #48bb78; 
        }

        /* é»˜è®¤æ–‡ä»¶å¤¹å›¾æ ‡å¤§å°è°ƒæ•´ */
        .folder-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* æ–‡ä»¶å¤¹åç§°å¾®è°ƒ */
        .folder-name {
            font-size: 10px;
            color: #ccc;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.2;
            padding: 0 2px;
        }
        
        .folder-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .folder-loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å›ºå®šå¯¼èˆªæŒ‰é’® */
        .nav-buttons {
            position: fixed;
            right: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            transition: right 0.3s ease;
        }

        .nav-buttons.hidden {
            right: -80px;
        }

        .nav-button {
            width: 50px;
            height: 50px;
            background: rgba(102, 126, 234, 0.9);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            outline: none;
        }
        
        .nav-button:focus {
            outline: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .nav-button:focus-visible {
            outline: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .nav-button:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .nav-button:active {
            transform: scale(0.95);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .nav-button:disabled:hover {
            transform: none;
            background: rgba(102, 126, 234, 0.9);
        }
        
        /* è‡ªå®šä¹‰å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: modalFadeIn 0.2s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #fff;
        }
        
        .modal-message {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 24px;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }
        
        .modal-btn-primary {
            background: #667eea;
            color: #fff;
        }
        
        .modal-btn-primary:hover {
            background: #5568d3;
        }
        
        .modal-btn-danger {
            background: #dc3545;
            color: #fff;
        }
        
        .modal-btn-danger:hover {
            background: #c82333;
        }
        
        .modal-btn-secondary {
            background: #3a3a3a;
            color: #fff;
        }
        
        .modal-btn-secondary:hover {
            background: #4a4a4a;
        }

        /* --- é•¿æŒ‰åé¦ˆé®ç½© --- */
        .long-press-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ï¼Œä¸é˜»æŒ¡æ“ä½œ */
            transition: opacity 0.2s;
        }

        .long-press-overlay.active {
            opacity: 1;
        }

        .long-press-overlay .icon {
            font-size: 40px;
            margin-bottom: 10px;
            color: #fff;
        }

        .long-press-overlay .text {
            font-size: 18px;
            color: #fff;
            font-weight: bold;
        }

        /* å·¦å³åŒºåŸŸé«˜äº®æ¸å˜ */
        .long-press-left {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.4) 0%, transparent 60%);
        }
        .long-press-right {
            background: linear-gradient(-90deg, rgba(102, 126, 234, 0.4) 0%, transparent 60%);
        }

        /* åº•éƒ¨ä¸Šæ‹‰æç¤ºå¾®è°ƒ */
        .next-chapter-hint {
            text-align: center;
            padding: 40px 0;
            color: #666;
            font-size: 14px;
            will-change: transform;
            /* å¢åŠ åº•éƒ¨å®‰å…¨åŒºï¼Œé˜²æ­¢è¢«æ‰‹æœºå°ç™½æ¡é®æŒ¡ */
            padding-bottom: env(safe-area-inset-bottom, 20px); 
        }

        /* ç§»åŠ¨ç«¯è¿”å›æŒ‰é’® */
        .mobile-back-btn {
            display: none;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .viewer-container {
                display: block;
                position: relative;
            }

            .sidebar {
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 10;
                border-right: none;
            }

            .main-view {
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 20;
                /* é»˜è®¤éšè—é˜…è¯»å™¨ */
                display: none !important;
            }

            /* --- æ¿€æ´»é˜…è¯»æ¨¡å¼çš„çŠ¶æ€ --- */
            /* å½“ body æœ‰è¿™ä¸ªç±»æ—¶ï¼Œéšè— sidebarï¼Œæ˜¾ç¤º main-view */
            body.mobile-reader-active .sidebar {
                display: none !important;
            }
            body.mobile-reader-active .main-view {
                display: flex !important;
            }

            /* éšè— PC ç«¯æ‰éœ€è¦çš„åˆ‡æ¢æŒ‰é’® */
            .toolbar-left button[onclick="toggleSidebar()"] {
                display: none;
            }

            /* æ˜¾ç¤ºç§»åŠ¨ç«¯è¿”å›æŒ‰é’® */
            .mobile-back-btn {
                display: inline-block;
                background-color: #667eea;
                border-color: #667eea;
                font-weight: bold;
            }

            .toolbar {
                padding: 8px 10px;
            }

            .toolbar-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .toolbar-left {
                flex-wrap: wrap;
            }

            .image-counter {
                font-size: 12px;
            }
            
            /* ç§»åŠ¨ç«¯é˜…è¯»å™¨ï¼šå‡å°è¾¹è·å’Œé—´è· */
            body.mobile-reader-active .image-viewer {
                padding: 5px; /* ä» 20px å‡å°åˆ° 5px */
            }
            
            body.mobile-reader-active .image-wrapper img {
                margin-bottom: 3px; /* ä» 10px å‡å°åˆ° 3px */
            }
            
            body.mobile-reader-active .toolbar {
                padding: 6px 8px; /* ä» 8px 10px å‡å°åˆ° 6px 8px */
            }

            .nav-buttons {
                right: 10px;
                bottom: 30px;
            }

            .nav-button {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                width: 100%;
            }

            .toolbar-btn {
                padding: 5px 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="viewer-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">å¡”å°ï¼Œå¡”å°ï¼Œä¸­å›½æœºé•¿ç”³è¯·èµ·é£</div>
                <div class="sidebar-header-actions">
                    <select id="comicDirSelect" class="sidebar-btn" style="padding: 4px 8px; font-size: 12px; cursor: pointer;" onchange="changeComicDir()" title="é€‰æ‹©æ¼«ç”»ç›®å½•">
                        <option value="JM">JM</option>
                        <option value="æ¼«ç”»">æ¼«ç”»</option>
                    </select>
                    <button class="sidebar-btn" onclick="goToIndex()" title="è¿”å›ä¸»ç•Œé¢">ğŸ </button>
                    <button class="sidebar-btn" onclick="forceRefresh()" title="å¼ºåˆ¶åˆ·æ–°">ğŸ”„</button>
                </div>
            </div>
            <div class="folder-browser" id="folderBrowser">
                <div class="breadcrumb-container">
                    <div class="breadcrumb-nav" id="folderBreadcrumb">
                        <span onclick="navigateToFolder('')">ğŸ“ä¸»ç›®å½•</span>
                    </div>
                    <div class="sort-controls">
                        <select id="sortSelect" class="sort-select" onchange="changeSort()">
                            <option value="time-desc">æ–°â†’æ—§</option>
                            <option value="time-asc">æ—§â†’æ–°</option>
                            <option value="name-asc">Aâ†’Z</option>
                            <option value="name-desc">Zâ†’A</option>
                        </select>
                    </div>
                </div>
                <div class="folder-list" id="folderList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
                <div class="pull-up-hint" id="pullUpHint">
                    <span class="icon">â†‘</span>
                    <span class="text">ä¸Šæ‹‰åŠ è½½æ›´å¤š</span>
                </div>
            </div>
            <div class="sidebar-section-title" id="imageListTitle" style="display: none;">å›¾ç‰‡åˆ—è¡¨</div>
            <div class="image-list" id="imageList">
                <div class="loading">è¯·é€‰æ‹©æ–‡ä»¶å¤¹</div>
            </div>
        </div>

        <!-- ä¸»è§†å›¾ -->
        <div class="main-view">
            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="toolbar-btn mobile-back-btn" onclick="goToParent()" title="è¿”å›ä¸Šä¸€çº§">â¬… è¿”å›é€‰é›†</button>
                    <button class="toolbar-btn" onclick="toggleSidebar()" title="æ˜¾ç¤º/éšè—åˆ—è¡¨">ğŸ“‹ åˆ—è¡¨</button>
                    <button class="toolbar-btn" onclick="toggleFullscreen()" title="å…¨å±/é€€å‡ºå…¨å±">â›¶ å…¨å±</button>
                    <button class="toolbar-btn" onclick="goToIndex()" title="è¿”å›ä¸»ç•Œé¢">ğŸ  ä¸»é¡µ</button>
                </div>
                <div class="toolbar-right">
                    <span class="image-counter" id="imageCounter">0 / 0</span>
                </div>
            </div>
            <div class="image-viewer scroll-mode" id="imageViewer">
                <div class="image-wrapper" id="imageWrapper">
                    <div class="loading" id="loadingText">è¯·ä»å·¦ä¾§é€‰æ‹©å›¾ç‰‡</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›ºå®šå¯¼èˆªæŒ‰é’® -->
    <div class="nav-buttons" id="navButtons">
        <button type="button" class="nav-button" id="goUpBtn" onclick="scrollToTop(event)" title="è¿”å›é¡¶éƒ¨">â¬†</button>
        <!-- éšè—è¿”å›ä¸Šä¸€å±‚çº§æŒ‰é’®ï¼Œåªä¿ç•™ä¾§è¾¹æ è¿”å›åŠŸèƒ½ -->
        <!-- <button type="button" class="nav-button" id="goRootBtn" onclick="goToParent()" title="è¿”å›ä¸Šä¸€å±‚çº§">â¬…</button> -->
    </div>
    
    <!-- è‡ªå®šä¹‰å¼¹çª— -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-message" id="modalMessage"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>
    
    <!-- é•¿æŒ‰åé¦ˆé®ç½© -->
    <div id="longPressOverlay" class="long-press-overlay">
        <div class="icon"></div>
        <div class="text"></div>
    </div>

    <script>
        // ==================== é…ç½®åŒºåŸŸ ====================
        const CONFIG = {
            // åç«¯APIåœ°å€é…ç½®
            API_BASE_URL: (() => {
                // ä¼˜å…ˆä»URLå‚æ•°è·å–
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('api')) {
                    return urlParams.get('api');
                }
                // ä»ç¯å¢ƒå˜é‡æˆ–localStorageè·å–
                if (window.API_BASE_URL) {
                    return window.API_BASE_URL;
                }
                const savedApi = localStorage.getItem('api_base_url');
                if (savedApi) {
                    return savedApi;
                }
                // é»˜è®¤ä½¿ç”¨å½“å‰é¡µé¢çš„åè®®å’Œä¸»æœºåï¼Œç«¯å£8000
                // å¦‚æœå‰ç«¯é€šè¿‡åŸŸåè®¿é—®ï¼ŒAPIä¹Ÿä½¿ç”¨ç›¸åŒåŸŸåï¼Œä½†ç«¯å£8000
                const protocol = window.location.protocol;
                const hostname = window.location.hostname;
                // å¦‚æœæ˜¯ localhost æˆ– 127.0.0.1ï¼Œç›´æ¥ä½¿ç”¨ localhost:8000
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'http://localhost:8000';
                }
                // å¦åˆ™ä½¿ç”¨å½“å‰ä¸»æœºåï¼Œä½†ç«¯å£8000ï¼ˆå‡è®¾åç«¯åœ¨åŒä¸€æœåŠ¡å™¨ï¼‰
                return `${protocol}//${hostname}:8000`;
            })(),
            // æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
            IMAGE_EXTENSIONS: ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp']
        };
        
        // ä¿å­˜APIåœ°å€åˆ°localStorageï¼ˆå¦‚æœé€šè¿‡URLå‚æ•°è®¾ç½®ï¼‰
        if (new URLSearchParams(window.location.search).get('api')) {
            localStorage.setItem('api_base_url', CONFIG.API_BASE_URL);
        }
        
        // ==================== å·¥å…·å‡½æ•° ====================
        /**
         * å®‰å…¨è½¬ä¹‰ HTMLï¼Œé˜²æ­¢ XSS æ”»å‡»
         * @param {string} text - éœ€è¦è½¬ä¹‰çš„æ–‡æœ¬
         * @returns {string} è½¬ä¹‰åçš„ HTML å®‰å…¨å­—ç¬¦ä¸²
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==================== ç§»åŠ¨ç«¯è§†å›¾æ§åˆ¶ ====================
        /**
         * è¿›å…¥ç§»åŠ¨ç«¯é˜…è¯»å™¨æ¨¡å¼
         */
        function enterMobileReader() {
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile-reader-active');
                // è¿›å…¥é˜…è¯»å™¨æ—¶ï¼Œç¡®ä¿æ»šåŠ¨æ¡åœ¨é¡¶éƒ¨
                const imageViewer = document.getElementById('imageViewer');
                if (imageViewer) {
                    imageViewer.scrollTop = 0;
                }
            }
        }
        
        /**
         * é€€å‡ºç§»åŠ¨ç«¯é˜…è¯»å™¨æ¨¡å¼
         */
        function exitMobileReader() {
            if (window.innerWidth <= 768) {
                document.body.classList.remove('mobile-reader-active');
            }
        }
        
        // ==================== çŠ¶æ€å˜é‡ ====================
        let currentImages = [];
        let currentIndex = -1;
        let currentFolderPath = '';
        let folderHistory = ['']; // æ–‡ä»¶å¤¹å†å²è·¯å¾„
        let currentSort = 'time-desc'; // å½“å‰æ’åºæ–¹å¼ï¼štime-desc, time-asc, name-asc, name-desc
        let currentPage = 1; // å½“å‰é¡µç ï¼ˆæ‰€æœ‰ç›®å½•éƒ½ä½¿ç”¨ï¼‰
        let folderPageMap = {}; // è®°å½•æ¯ä¸ªè·¯å¾„çš„é¡µç  {path: page}
        let pageSize = 20; // æ¯é¡µæ˜¾ç¤ºæ•°é‡
        let totalFolders = 0; // æ€»æ–‡ä»¶å¤¹æ•°
        let totalPages = 1; // æ€»é¡µæ•°
        let currentComicDir = localStorage.getItem('selectedComicDir') || 'JM'; // å½“å‰é€‰æ‹©çš„æ¼«ç”»ç›®å½•ï¼ˆä» localStorage è¯»å–æˆ–é»˜è®¤ JMï¼‰

        // ==================== æœ¬åœ°è¿›åº¦ç®¡ç†å™¨ ====================
        const ProgressMgr = {
            save: (path, pageIndex, total) => {
                const history = JSON.parse(localStorage.getItem('reading_history') || '{}');
                history[path] = {
                    page: pageIndex,
                    total: total,
                    timestamp: Date.now()
                };
                // ç®€å•æ¸…ç†ï¼šåªä¿ç•™æœ€è¿‘ 500 æ¡
                const keys = Object.keys(history);
                if (keys.length > 500) {
                    delete history[keys.sort((a,b) => history[a].timestamp - history[b].timestamp)[0]];
                }
                localStorage.setItem('reading_history', JSON.stringify(history));
            },
            
            get: (path) => {
                const history = JSON.parse(localStorage.getItem('reading_history') || '{}');
                return history[path];
            }
        };
        let imageLoadQueue = []; // å›¾ç‰‡åŠ è½½é˜Ÿåˆ—
        let isLoadingImages = false; // æ˜¯å¦æ­£åœ¨åŠ è½½å›¾ç‰‡
        let loadedImageCount = 0; // å·²åŠ è½½çš„å›¾ç‰‡æ•°é‡
        const BATCH_SIZE = 5; // æ¯æ‰¹åŠ è½½çš„å›¾ç‰‡æ•°é‡
        const PRELOAD_RANGE = 5; // é¢„åŠ è½½å½“å‰å›¾ç‰‡å‰åå„å‡ å¼ ï¼ˆä»3å¢åŠ åˆ°5ï¼Œæå‰åŠ è½½æ›´å¤šï¼‰
        let isLoadingFolders = false; // æ˜¯å¦æ­£åœ¨åŠ è½½æ–‡ä»¶å¤¹ï¼ˆé˜²æ­¢é‡å¤åŠ è½½ï¼‰
        let hasReachedEnd = false; // æ˜¯å¦å·²ç»åˆ°è¾¾æœ€åä¸€é¡µï¼ˆé˜²æ­¢æ— é™åŠ è½½ï¼‰
        let consecutiveFailures = 0; // è¿ç»­å¤±è´¥æ¬¡æ•°
        const MAX_CONSECUTIVE_FAILURES = 3; // æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°ï¼Œè¶…è¿‡ååœæ­¢è‡ªåŠ¨åŠ è½½
        let consecutiveEmptyPages = 0; // è¿ç»­ç©ºé¡µè®¡æ•°ï¼ˆæ²¡æœ‰æ–‡ä»¶å¤¹çš„é¡µæ•°ï¼‰
        const MAX_CONSECUTIVE_EMPTY_PAGES = 5; // æœ€å¤§è¿ç»­ç©ºé¡µæ•°ï¼Œè¶…è¿‡ååœæ­¢è‡ªåŠ¨åŠ è½½
        let mainImageObserver = null; // ä¸»å›¾è§‚å¯Ÿå™¨ï¼ˆå…¨å±€å˜é‡ï¼Œæ–¹ä¾¿é”€æ¯ï¼‰
        let pageCounterObserver = null; // é¡µç è®¡æ•°å™¨è§‚å¯Ÿå™¨ï¼ˆå…¨å±€å˜é‡ï¼Œæ–¹ä¾¿é”€æ¯ï¼‰
        let thumbnailObserver; // ç¼©ç•¥å›¾è§‚å¯Ÿå™¨

        // ==================== åˆå§‹åŒ–å‡½æ•° ====================
        /**
         * åˆå§‹åŒ–åº”ç”¨
         */
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // åŠ è½½å¯ç”¨çš„æ¼«ç”»ç›®å½•åˆ—è¡¨
            await loadComicDirs();
            
            setupKeyboard();
            setupObservers(); // æ³¨å†Œè§‚å¯Ÿå™¨
            setupPullUpToLoad(); // æ³¨å†Œä¸Šæ‹‰æ‰‹åŠ¿ï¼ˆæ›¿æ¢åŸæ¥çš„ setupScrollToLoadï¼‰
            setupImageViewerInteractions(); // æ³¨å†Œå›¾ç‰‡æŸ¥çœ‹å™¨çš„é•¿æŒ‰å’Œä¸Šæ‹‰è·³è½¬äº¤äº’
            updateNavButtons();

            // 1. å¤„ç†æµè§ˆå™¨åé€€/å‰è¿›æŒ‰é’®
            window.addEventListener('popstate', async (event) => {
                // ä¼˜å…ˆé€€å‡ºç§»åŠ¨ç«¯é˜…è¯»å™¨æ ·å¼
                if (document.body.classList.contains('mobile-reader-active')) {
                    exitMobileReader();
                    // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šåˆ é™¤ return åï¼Œä»£ç ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œ
                    // æµè§ˆå™¨å·²ç»å›é€€äº† URLï¼Œä¸‹é¢ä¼šè·å– event.state.folder (å³ä¸Šä¸€çº§ç›®å½•) å¹¶åŠ è½½å®ƒ
                    // return; 
                }
                
                if (event.state && event.state.folder !== undefined) {
                    // å†å²è®°å½•é‡Œæœ‰çŠ¶æ€ï¼ŒåŠ è½½å¯¹åº”æ–‡ä»¶å¤¹ (ä¼ å…¥ false è¡¨ç¤ºè¿™æ˜¯å†å²è®°å½•æ“ä½œï¼Œä¸è¦å† pushState)
                    await navigateToFolder(event.state.folder, false);
                } else {
                    // å†å²è®°å½•ä¸ºç©ºï¼ˆé€šå¸¸æ˜¯å›åˆ°äº†é¦–é¡µï¼‰ï¼ŒåŠ è½½æ ¹ç›®å½•
                    await navigateToFolder('', false);
                }
            });

            // 2. åˆå§‹åŠ è½½
            // å¦‚æœ URL å‚æ•°é‡Œæœ‰ folderï¼ŒåŠ è½½å®ƒï¼›å¦åˆ™åŠ è½½æ ¹ç›®å½•
            const initialFolder = urlParams.get('folder') || '';
            
            // æ›¿æ¢å½“å‰å†å²è®°å½•çŠ¶æ€ï¼Œç¡®ä¿åˆå§‹çŠ¶æ€æ­£ç¡®
            history.replaceState({ folder: initialFolder }, '', initialFolder ? `?folder=${encodeURIComponent(initialFolder)}` : window.location.pathname);
            
            await loadFolders(initialFolder || '', 1);
            if (initialFolder) {
                await navigateToFolder(initialFolder, false);
            }
            
            // è¾“å‡ºé…ç½®ä¿¡æ¯ï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼‰
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('API Base URL:', CONFIG.API_BASE_URL);
            }
        }

        // ==================== APIè°ƒç”¨å‡½æ•° ====================
        /**
         * è·å–æ–‡ä»¶å¤¹çš„ç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼©ç•¥å›¾
         * ç¼“å­˜ç”±åç«¯ Redis å¤„ç†
         */
        async function getFolderThumbnail(folderPath, cacheBuster = null) {
            try {
                const cacheParam = cacheBuster ? `&_t=${cacheBuster}` : '';
                const comicDirParam = currentComicDir ? `&comic_dir=${encodeURIComponent(currentComicDir)}` : '';
                const url = `${CONFIG.API_BASE_URL}/api/files?path=${encodeURIComponent(folderPath)}${comicDirParam}${cacheParam}`;
                
                const fetchOptions = cacheBuster ? {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                } : {};
                
                const response = await fetch(url, fetchOptions);
                const data = await response.json();
                
                if (data.success && data.items) {
                    const firstImage = data.items.find(item => {
                        if (item.type === 'directory') return false;
                        const lastDotIndex = item.name.lastIndexOf('.');
                        if (lastDotIndex === -1 || lastDotIndex === item.name.length - 1) {
                            return false;
                        }
                        const ext = item.name.toLowerCase().substring(lastDotIndex);
                        return CONFIG.IMAGE_EXTENSIONS.includes(ext);
                    });
                    
                    if (firstImage) {
                        // ä½¿ç”¨ç¼©ç•¥å›¾APIç”Ÿæˆå°é¢å›¾ç‰‡
                        const comicDirParam = currentComicDir ? `&comic_dir=${encodeURIComponent(currentComicDir)}` : '';
                        return `${CONFIG.API_BASE_URL}/api/thumbnail/${encodeURIComponent(folderPath)}?width=200&height=200${comicDirParam}`;
                    }
                }
            } catch (error) {
                console.error('è·å–ç¼©ç•¥å›¾å¤±è´¥:', error);
            }
            
            return null;
        }

        /**
         * åŠ è½½å¯ç”¨çš„æ¼«ç”»ç›®å½•åˆ—è¡¨
         */
        async function loadComicDirs() {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/comic-dirs`);
                const data = await response.json();
                
                if (data.success && data.dirs) {
                    const select = document.getElementById('comicDirSelect');
                    if (select) {
                        // åªä¿ç•™ JM å’Œ æ¼«ç”» ä¸¤ä¸ªé€‰é¡¹
                        select.innerHTML = '';
                        
                        // æ·»åŠ  JM é€‰é¡¹
                        const jmOption = document.createElement('option');
                        jmOption.value = 'JM';
                        jmOption.textContent = 'JM';
                        select.appendChild(jmOption);
                        
                        // æ·»åŠ  æ¼«ç”» é€‰é¡¹
                        const comicOption = document.createElement('option');
                        comicOption.value = 'æ¼«ç”»';
                        comicOption.textContent = 'æ¼«ç”»';
                        select.appendChild(comicOption);
                        
                        // ç¡®å®šå½“å‰åº”è¯¥é€‰ä¸­çš„ç›®å½•
                        // 1. ä¼˜å…ˆä½¿ç”¨å·²ä¿å­˜çš„é€‰æ‹©ï¼ˆlocalStorage æˆ– currentComicDirï¼‰
                        // 2. å¦‚æœå½“å‰å€¼ä¸æ˜¯ 'JM' æˆ– 'æ¼«ç”»'ï¼Œæ£€æŸ¥åç«¯è¿”å›çš„ current å€¼
                        // 3. å¦‚æœéƒ½ä¸ç¬¦åˆï¼Œé»˜è®¤ä½¿ç”¨ 'JM'
                        let targetDir = currentComicDir;
                        
                        // å¦‚æœå½“å‰å€¼ä¸æ˜¯ 'JM' æˆ– 'æ¼«ç”»'ï¼Œéœ€è¦é‡æ–°ç¡®å®š
                        if (targetDir !== 'JM' && targetDir !== 'æ¼«ç”»') {
                            // æ£€æŸ¥åç«¯è¿”å›çš„ current å€¼
                            if (data.current === 'JM' || data.current === 'æ¼«ç”»') {
                                targetDir = data.current;
                            } else {
                                // é»˜è®¤ä½¿ç”¨ 'JM'
                                targetDir = 'JM';
                            }
                            // æ›´æ–° currentComicDir
                            currentComicDir = targetDir;
                        }
                        
                        // ç¡®ä¿ currentComicDir æ˜¯æœ‰æ•ˆçš„å€¼
                        if (currentComicDir !== 'JM' && currentComicDir !== 'æ¼«ç”»') {
                            currentComicDir = 'JM';
                        }
                        
                        // è®¾ç½®ä¸‹æ‹‰æ¡†çš„é€‰ä¸­çŠ¶æ€
                        select.value = currentComicDir;
                        
                        // æ ¹æ®å½“å‰ç›®å½•è®¾ç½®é»˜è®¤æ’åº
                        if (currentComicDir === 'JM') {
                            currentSort = 'time-desc';
                        } else if (currentComicDir === 'æ¼«ç”»') {
                            currentSort = 'name-asc';
                        } else {
                            currentSort = 'time-desc';
                        }
                        
                        // æ›´æ–°æ’åºé€‰æ‹©æ¡†
                        const sortSelect = document.getElementById('sortSelect');
                        if (sortSelect) {
                            sortSelect.value = currentSort;
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ¼«ç”»ç›®å½•åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        /**
         * åˆ‡æ¢æ¼«ç”»ç›®å½•
         */
        function changeComicDir() {
            const select = document.getElementById('comicDirSelect');
            if (select) {
                const newDir = select.value;
                
                // å¦‚æœé€‰æ‹©æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥è¿”å›
                if (newDir === currentComicDir) {
                    return;
                }
                
                currentComicDir = newDir;
                
                // ä¿å­˜ç”¨æˆ·é€‰æ‹©åˆ° localStorage
                localStorage.setItem('selectedComicDir', currentComicDir);
                
                // æ ¹æ®ä¸åŒçš„ç›®å½•è®¾ç½®ä¸åŒçš„é»˜è®¤æ’åº
                // JM ç›®å½•ï¼šé»˜è®¤æŒ‰æ—¶é—´é™åºï¼ˆæ–°â†’æ—§ï¼‰
                // æ¼«ç”»ç›®å½•ï¼šé»˜è®¤æŒ‰åç§°å‡åºï¼ˆAâ†’Zï¼‰
                if (currentComicDir === 'JM') {
                    currentSort = 'time-desc';
                } else if (currentComicDir === 'æ¼«ç”»') {
                    currentSort = 'name-asc';
                } else {
                    // å…¶ä»–ç›®å½•é»˜è®¤ä½¿ç”¨æ—¶é—´é™åº
                    currentSort = 'time-desc';
                }
                
                // æ›´æ–°æ’åºé€‰æ‹©æ¡†
                const sortSelect = document.getElementById('sortSelect');
                if (sortSelect) {
                    sortSelect.value = currentSort;
                }
                
                // é‡ç½®åˆ°æ ¹ç›®å½•å¹¶é‡æ–°åŠ è½½
                currentFolderPath = '';
                folderHistory = [''];
                currentPage = 1;
                // é‡ç½®åŠ è½½çŠ¶æ€æ ‡å¿—
                hasReachedEnd = false; // é‡ç½®åˆ°åº•æ ‡å¿—
                totalPages = 1;        // é‡ç½®æ€»é¡µæ•°ï¼Œé˜²æ­¢è¢«ä¸Šä¸€ä¸ªæ–‡ä»¶å¤¹çš„æ€»é¡µæ•°è¯¯å¯¼
                consecutiveFailures = 0;
                consecutiveEmptyPages = 0; // é‡ç½®è¿ç»­ç©ºé¡µè®¡æ•°
                // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
                const breadcrumb = document.getElementById('folderBreadcrumb');
                if (breadcrumb) {
                    breadcrumb.innerHTML = '<span onclick="navigateToFolder(\'\')">ğŸ“ä¸»ç›®å½•</span>';
                }
                loadFolders('', 1, Date.now()); // ä½¿ç”¨æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–°
            }
        }

        // æ”¹å˜æ’åºæ–¹å¼
        function changeSort() {
            const sortSelect = document.getElementById('sortSelect');
            currentSort = sortSelect.value;
            // é‡æ–°åŠ è½½å½“å‰æ–‡ä»¶å¤¹ï¼ˆé‡ç½®åˆ°ç¬¬ä¸€é¡µï¼‰
            currentPage = 1;
            folderPageMap[currentFolderPath || ''] = 1;
            // é‡ç½®åŠ è½½çŠ¶æ€æ ‡å¿—
            hasReachedEnd = false; // é‡ç½®åˆ°åº•æ ‡å¿—
            totalPages = 1;        // é‡ç½®æ€»é¡µæ•°ï¼Œé˜²æ­¢è¢«ä¸Šä¸€ä¸ªæ–‡ä»¶å¤¹çš„æ€»é¡µæ•°è¯¯å¯¼
            consecutiveFailures = 0;
            loadFolders(currentFolderPath || '', 1);
        }
        
        // åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
        async function loadFolders(path = '', page = 1, cacheBuster = null, append = false) {
            // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œä¸”ä¸æ˜¯è¿½åŠ æ¨¡å¼ï¼Œç›´æ¥è¿”å›
            if (isLoadingFolders && !append) {
                return;
            }
            
            // å¦‚æœæ˜¯è¿½åŠ æ¨¡å¼ï¼Œä¸”å·²ç»åˆ°åº•äº†ï¼Œåšå†³ä¸åŠ è½½
            if (append && (hasReachedEnd || page > totalPages)) {
                return; 
            }
            
            // å¦‚æœæ˜¯è¿½åŠ æ¨¡å¼ï¼Œæ˜¾ç¤ºåŠ è½½æç¤º
            if (append) {
                if (isLoadingFolders) return; // é˜²æ­¢é‡å¤è¿½åŠ 
                isLoadingFolders = true;
                const folderList = document.getElementById('folderList');
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading';
                loadingDiv.id = 'loadingMore';
                loadingDiv.textContent = 'åŠ è½½ä¸­...';
                folderList.appendChild(loadingDiv);
            } else {
                const folderList = document.getElementById('folderList');
                folderList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            }
            
            isLoadingFolders = true;
            
            try {
                // è§£ææ’åºå‚æ•°
                const [sortBy, order] = currentSort.split('-');
                // æ‰€æœ‰ç›®å½•éƒ½ä½¿ç”¨åˆ†é¡µ
                const pageParam = `&page=${page}&page_size=${pageSize}`;
                // æ·»åŠ å¼ºåˆ¶åˆ·æ–°å‚æ•°ï¼ˆç»•è¿‡ç¼“å­˜ï¼‰
                const cacheParam = cacheBuster ? `&_t=${cacheBuster}` : '';
                const comicDirParam = currentComicDir ? `&comic_dir=${encodeURIComponent(currentComicDir)}` : '';
                const url = path ? 
                    `${CONFIG.API_BASE_URL}/api/files?path=${encodeURIComponent(path)}&sort_by=${sortBy}&order=${order}${pageParam}${comicDirParam}${cacheParam}` : 
                    `${CONFIG.API_BASE_URL}/api/files?sort_by=${sortBy}&order=${order}${pageParam}${comicDirParam}${cacheParam}`;
                
                // ä½¿ç”¨ no-cache é€‰é¡¹å¼ºåˆ¶è·å–æœ€æ–°æ•°æ®
                const fetchOptions = cacheBuster ? {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                } : {};
                
                const response = await fetch(url, fetchOptions);
                const data = await response.json();
                
                // è°ƒè¯•ï¼šè¾“å‡ºAPIå“åº”
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.log('loadFolders APIå“åº”:', { path, page, url, data });
                }
                
                // æ£€æŸ¥å“åº”æ•°æ®
                if (!data) {
                    console.error('APIè¿”å›æ•°æ®ä¸ºç©º');
                    consecutiveFailures++;
                    const folderList = document.getElementById('folderList');
                    if (!append) {
                        folderList.innerHTML = '<div class="loading" style="grid-column: 1/-1;">APIè¿”å›æ•°æ®ä¸ºç©º</div>';
                    } else {
                        // è¿½åŠ æ¨¡å¼ä¸‹ï¼Œå¦‚æœè¿ç»­å¤±è´¥å¤ªå¤šæ¬¡ï¼Œåœæ­¢åŠ è½½
                        if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES) {
                            hasReachedEnd = true;
                            const loadingMore = document.getElementById('loadingMore');
                            if (loadingMore) {
                                loadingMore.remove();
                            }
                        }
                    }
                    return;
                }
                
                // å¦‚æœAPIè¿”å›é”™è¯¯ï¼Œä¹Ÿæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (!data.success) {
                    console.error('APIè¿”å›é”™è¯¯:', data);
                    consecutiveFailures++;
                    const folderList = document.getElementById('folderList');
                    if (!append) {
                        folderList.innerHTML = `<div class="loading" style="grid-column: 1/-1;">åŠ è½½å¤±è´¥: ${data.detail || 'æœªçŸ¥é”™è¯¯'}</div>`;
                    } else {
                        // è¿½åŠ æ¨¡å¼ä¸‹ï¼Œå¦‚æœè¿ç»­å¤±è´¥å¤ªå¤šæ¬¡ï¼Œåœæ­¢åŠ è½½
                        if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES) {
                            hasReachedEnd = true;
                            const loadingMore = document.getElementById('loadingMore');
                            if (loadingMore) {
                                loadingMore.remove();
                            }
                        }
                    }
                    return;
                }
                
                // æˆåŠŸåŠ è½½ï¼Œé‡ç½®å¤±è´¥è®¡æ•°å™¨
                consecutiveFailures = 0;
                
                if (data.items) {
                    // æ›´æ–°æ€»é¡µæ•°
                    if (data.total_pages !== undefined) {
                        totalPages = data.total_pages;
                        totalFolders = data.total;
                        // è°ƒè¯•ä¿¡æ¯
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            console.log('åˆ†é¡µä¿¡æ¯:', { 
                                currentPage: page, 
                                totalPages, 
                                totalFolders, 
                                itemsCount: data.items.length,
                                foldersCount: data.items.filter(item => item.type === 'directory').length
                            });
                        }
                    }
                    
                    // è¿‡æ»¤æ–‡ä»¶å¤¹
                    const newFolders = data.items.filter(item => item.type === 'directory');

                    // --- ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºç©º ---
                    // åªæœ‰å½“æ²¡æœ‰æ–‡ä»¶å¤¹ä¸”å·²ç»æ˜¯æœ€åä¸€é¡µæ—¶ï¼Œæ‰è®¤ä¸ºåˆ°åº•äº†
                    if (newFolders.length === 0) {
                        // æ›´æ–°å½“å‰é¡µç 
                        currentPage = page;
                        folderPageMap[path || ''] = currentPage;
                        
                        // å¢åŠ è¿ç»­ç©ºé¡µè®¡æ•°
                        consecutiveEmptyPages++;
                        
                        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µï¼Œä¸”è¿ç»­ç©ºé¡µæ•°æœªè¶…è¿‡é™åˆ¶
                        if (currentPage >= totalPages || consecutiveEmptyPages >= MAX_CONSECUTIVE_EMPTY_PAGES) {
                            // ç¡®å®æ˜¯æœ€åä¸€é¡µï¼Œæˆ–è€…è¿ç»­å¤ªå¤šç©ºé¡µï¼Œè®¤ä¸ºåˆ°åº•äº†
                            hasReachedEnd = true;
                            consecutiveEmptyPages = 0; // é‡ç½®è®¡æ•°å™¨
                            if (append) {
                                const loadingMore = document.getElementById('loadingMore');
                                if (loadingMore) loadingMore.remove();
                                
                                const hintEl = document.getElementById('pullUpHint');
                                if (hintEl) {
                                    const hintText = hintEl.querySelector('.text');
                                    if (hintText) hintText.textContent = "æ²¡æœ‰æ›´å¤šäº†";
                                }
                            } else {
                                const folderList = document.getElementById('folderList');
                                folderList.innerHTML = '<div class="loading" style="grid-column: 1/-1;">æ²¡æœ‰å­æ–‡ä»¶å¤¹</div>';
                            }
                            return;
                        } else {
                            // è¿˜æœ‰ä¸‹ä¸€é¡µï¼Œä½†å½“å‰é¡µæ²¡æœ‰æ–‡ä»¶å¤¹ï¼Œç»§ç»­åŠ è½½ä¸‹ä¸€é¡µ
                            if (append) {
                                const loadingMore = document.getElementById('loadingMore');
                                if (loadingMore) loadingMore.remove();
                                
                                // è‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µ
                                const nextPage = currentPage + 1;
                                folderPageMap[path || ''] = nextPage;
                                await loadFolders(path, nextPage, cacheBuster, true);
                            } else {
                                // éè¿½åŠ æ¨¡å¼ï¼Œå¦‚æœç¬¬ä¸€é¡µå°±æ²¡æœ‰æ–‡ä»¶å¤¹ï¼Œæ˜¾ç¤ºæç¤º
                                const folderList = document.getElementById('folderList');
                                folderList.innerHTML = '<div class="loading" style="grid-column: 1/-1;">å½“å‰é¡µæ²¡æœ‰å­æ–‡ä»¶å¤¹ï¼Œæ­£åœ¨åŠ è½½ä¸‹ä¸€é¡µ...</div>';
                                // è‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µ
                                const nextPage = currentPage + 1;
                                folderPageMap[path || ''] = nextPage;
                                await loadFolders(path, nextPage, cacheBuster, false);
                            }
                            return;
                        }
                    }
                    
                    // å¦‚æœæœ‰æ–‡ä»¶å¤¹ï¼Œé‡ç½®è¿ç»­ç©ºé¡µè®¡æ•°
                    consecutiveEmptyPages = 0;

                    // --- æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦é‡å¤ ---
                    // å¦‚æœæ˜¯è¿½åŠ æ¨¡å¼ï¼Œæ£€æŸ¥æ–°åŠ è½½çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶å¤¹æ˜¯å¦å·²ç»å­˜åœ¨äºåˆ—è¡¨ä¸­
                    // é˜²æ­¢åç«¯é¡µç è®¡ç®—é”™è¯¯å¯¼è‡´è¿”å›é‡å¤æ•°æ®
                    if (append) {
                        const folderList = document.getElementById('folderList');
                        const lastItem = folderList.lastElementChild;
                        if (lastItem) {
                            const lastTitle = lastItem.getAttribute('title'); // è·å–å·²å­˜åœ¨çš„æœ€åä¸€ä¸ªæ–‡ä»¶å¤¹å
                            if (newFolders.length > 0 && newFolders[0].name === lastTitle) {
                                console.warn('æ£€æµ‹åˆ°é‡å¤æ•°æ®ï¼Œåœæ­¢åŠ è½½');
                                hasReachedEnd = true;
                                const loadingMore = document.getElementById('loadingMore');
                                if (loadingMore) loadingMore.remove();
                                return;
                            }
                        }
                    }
                    
                    // ä½¿ç”¨ newFolders ä½œä¸º folders
                    const folders = newFolders;
                    
                    if (folders.length > 0) {
                        const folderList = document.getElementById('folderList');
                        
                        // å¦‚æœæ˜¯è¿½åŠ æ¨¡å¼ï¼Œç§»é™¤åŠ è½½æç¤º
                        if (append) {
                            const loadingMore = document.getElementById('loadingMore');
                            if (loadingMore) {
                                loadingMore.remove();
                            }
                        } else {
                            folderList.innerHTML = '';
                        }
                        
                        let html = '';
                        // è·å–å½“å‰å·²æœ‰çš„æ–‡ä»¶å¤¹æ•°é‡ï¼ˆç”¨äºç´¢å¼•ï¼‰
                        const existingCount = folderList.querySelectorAll('.folder-item').length;
                        // å…ˆæ¸²æŸ“æ‰€æœ‰æ–‡ä»¶å¤¹é¡¹ï¼ˆä¸ç­‰å¾…ç¼©ç•¥å›¾ï¼‰
                        folders.forEach((folder, index) => {
                            // 1. ç”Ÿæˆå®‰å…¨çš„ DOM å­—ç¬¦ä¸²ï¼ˆç”¨äº HTML å†…å®¹ï¼‰
                            const safeName = escapeHtml(folder.name);
                            // 2. è·¯å¾„è½¬ä¹‰ï¼ˆç”¨äº JS å‚æ•°ï¼‰
                            const jsPath = folder.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                            const jsName = folder.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                            const uniqueId = `folder-${Date.now()}-${existingCount + index}`;
                            
                            // è·å–è¿›åº¦
                            const progress = ProgressMgr.get(folder.path);
                            let progressHtml = '';

                            if (progress) {
                                const percent = Math.min(100, Math.round(((progress.page + 1) / progress.total) * 100));
                                const isFinished = percent > 95; // è¶…è¿‡95%ç®—è¯»å®Œ
                                
                                progressHtml = `
                                    <div class="progress-bar-bg">
                                        <div class="progress-bar-fill ${isFinished ? 'finished' : ''}" style="width: ${percent}%"></div>
                                    </div>
                                `;
                            }
                            
                            html += `
                                <div class="folder-item" onclick="navigateToFolder('${jsPath}')" title="${safeName}" data-folder-index="${existingCount + index}">
                                    <button class="folder-delete-btn" onclick="event.stopPropagation(); deleteFolder('${jsPath}', '${jsName}')" title="åˆ é™¤æ–‡ä»¶å¤¹">Ã—</button>
                                    <div class="folder-loading" id="loading-${uniqueId}">
                                        <div class="folder-loading-spinner"></div>
                                    </div>
                                    <div class="folder-icon" id="icon-${uniqueId}" style="display: none;">ğŸ“</div>
                                    <div class="folder-name">${safeName}</div>
                                    ${progressHtml}
                                </div>
                            `;
                        });
                        // è¿½åŠ æˆ–è®¾ç½®HTML
                        if (append) {
                            folderList.insertAdjacentHTML('beforeend', html);
                        } else {
                            folderList.innerHTML = html;
                        }
                        
                        // å¼‚æ­¥åŠ è½½ç¼©ç•¥å›¾ï¼ˆä¸é˜»å¡æ¸²æŸ“ï¼‰
                        folders.forEach(async (folder, index) => {
                            const folderItem = folderList.querySelector(`[data-folder-index="${existingCount + index}"]`);
                            if (!folderItem) return;
                            
                            // è·å–å”¯ä¸€çš„ ID
                            const loadingEl = folderItem.querySelector('.folder-loading');
                            const iconEl = folderItem.querySelector('.folder-icon');
                            
                            try {
                                // å¦‚æœæ˜¯åœ¨å¼ºåˆ¶åˆ·æ–°æ¨¡å¼ä¸‹ï¼Œç¼©ç•¥å›¾ä¹Ÿéœ€è¦ç»•è¿‡ç¼“å­˜
                                const thumbnail = await getFolderThumbnail(folder.path, cacheBuster);
                                if (thumbnail) {
                                    const img = document.createElement('img');
                                    img.className = 'folder-thumbnail';
                                    img.alt = '';
                                    
                                    // ä½¿ç”¨ data-src è¿›è¡Œæ‡’åŠ è½½
                                    const realSrc = cacheBuster ? `${thumbnail}${thumbnail.includes('?') ? '&' : '?'}_t=${cacheBuster}` : thumbnail;
                                    
                                    // å¦‚æœæ”¯æŒè§‚å¯Ÿå™¨ï¼Œç”¨ data-src
                                    if (thumbnailObserver) {
                                        img.setAttribute('data-src', realSrc);
                                        img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; // é€æ˜å ä½
                                        thumbnailObserver.observe(img);
                                    } else {
                                        img.src = realSrc; // é™çº§å¤„ç†
                                    }
                                    
                                    // å…ˆæ’å…¥DOM
                                    if (loadingEl && loadingEl.nextSibling) {
                                        folderItem.insertBefore(img, loadingEl.nextSibling);
                                    } else if (iconEl) {
                                        folderItem.insertBefore(img, iconEl);
                                    } else {
                                        folderItem.insertBefore(img, folderItem.querySelector('.folder-name'));
                                    }
                                    
                                    // éšè— loadingï¼Œæ˜¾ç¤ºå›¾ç‰‡å ä½
                                    if (loadingEl) loadingEl.style.display = 'none';
                                    if (iconEl) iconEl.style.display = 'none';
                                    
                                    // è®¾ç½®åŠ è½½å®Œæˆå’Œå¤±è´¥çš„å›è°ƒ
                                    img.onload = () => {
                                        // å¦‚æœæ˜¯å ä½å›¾onloadä¸å¤„ç†ï¼Œåªæœ‰çœŸå®å›¾ç‰‡åŠ è½½æ‰å¤„ç†
                                        if (img.src !== "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7") {
                                            img.classList.add('loaded'); // æ˜¾ç¤ºå›¾ç‰‡
                                        }
                                    };
                                    
                                    img.onerror = () => {
                                        // ç¼©ç•¥å›¾åŠ è½½å¤±è´¥ï¼šéšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡ï¼Œç§»é™¤å›¾ç‰‡
                                        if (loadingEl) loadingEl.style.display = 'none';
                                        if (iconEl) iconEl.style.display = 'flex';
                                        img.remove();
                                    };
                                } else {
                                    // æ²¡æœ‰ç¼©ç•¥å›¾ï¼šéšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡
                                    if (loadingEl) loadingEl.style.display = 'none';
                                    if (iconEl) iconEl.style.display = 'flex';
                                }
                            } catch (error) {
                                // åŠ è½½å‡ºé”™ï¼šéšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡
                                console.error('åŠ è½½ç¼©ç•¥å›¾å¤±è´¥:', error);
                                if (loadingEl) loadingEl.style.display = 'none';
                                if (iconEl) iconEl.style.display = 'flex';
                            }
                        });
                    } else {
                        const folderList = document.getElementById('folderList');
                        if (!append) {
                            folderList.innerHTML = '<div class="loading" style="grid-column: 1/-1;">æ²¡æœ‰å­æ–‡ä»¶å¤¹</div>';
                        } else {
                            const loadingMore = document.getElementById('loadingMore');
                            if (loadingMore) {
                                loadingMore.remove();
                            }
                        }
                    }
                    
                    // æ¸²æŸ“å®Œæ¯•åï¼Œæ›´æ–°å½“å‰é¡µç 
                    currentPage = page;
                    // ä¿å­˜å½“å‰è·¯å¾„çš„é¡µç 
                    folderPageMap[path || ''] = currentPage;
                    updateFolderPagination();
                    
                    // å†æ¬¡æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æœ€åä¸€é¡µ
                    // åªæœ‰å½“ç¡®å®æ˜¯æœ€åä¸€é¡µæ—¶ï¼Œæ‰è®¤ä¸ºåˆ°åº•äº†
                    // å¦‚æœå½“å‰é¡µè¿”å›çš„æ–‡ä»¶å¤¹æ•°é‡ç­‰äº pageSizeï¼Œå¯èƒ½è¿˜æœ‰ä¸‹ä¸€é¡µï¼ˆå³ä½¿ totalPages æ˜¾ç¤ºåªæœ‰1é¡µï¼Œä¹Ÿå¯èƒ½æœ‰æ›´å¤šæ•°æ®ï¼‰
                    if (currentPage >= totalPages) {
                        // å¦‚æœå½“å‰é¡µè¿”å›çš„æ–‡ä»¶å¤¹æ•°é‡ç­‰äº pageSizeï¼Œå¯èƒ½åç«¯çš„åˆ†é¡µä¿¡æ¯ä¸å‡†ç¡®ï¼Œä¸åº”è¯¥è®¾ç½® hasReachedEnd
                        const foldersCount = newFolders.length;
                        if (foldersCount === pageSize) {
                            // å½“å‰é¡µè¿”å›çš„æ–‡ä»¶å¤¹æ•°é‡ç­‰äº pageSizeï¼Œå¯èƒ½è¿˜æœ‰ä¸‹ä¸€é¡µï¼Œä¸è®¾ç½® hasReachedEnd
                            hasReachedEnd = false;
                            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                                console.warn('å½“å‰é¡µè¿”å›çš„æ–‡ä»¶å¤¹æ•°é‡ç­‰äº pageSizeï¼Œä½† totalPages æ˜¾ç¤ºå·²åˆ°åº•ï¼Œå¯èƒ½å­˜åœ¨åˆ†é¡µä¿¡æ¯ä¸å‡†ç¡®çš„é—®é¢˜');
                            }
                        } else {
                            hasReachedEnd = true;
                        }
                    } else {
                        // è¿˜æœ‰ä¸‹ä¸€é¡µï¼Œä¸åº”è¯¥è®¾ç½® hasReachedEnd
                        hasReachedEnd = false;
                    }
                    
                    updateFolderBreadcrumb(path);
                }
            } catch (error) {
                consecutiveFailures++;
                const folderList = document.getElementById('folderList');
                if (!append) {
                    folderList.innerHTML = '<div class="loading" style="grid-column: 1/-1;">åŠ è½½å¤±è´¥</div>';
                } else {
                    const loadingMore = document.getElementById('loadingMore');
                    if (loadingMore) {
                        loadingMore.textContent = 'åŠ è½½å¤±è´¥';
                        // å¦‚æœè¿ç»­å¤±è´¥å¤ªå¤šæ¬¡ï¼Œåœæ­¢åŠ è½½
                        if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES) {
                            hasReachedEnd = true;
                            loadingMore.remove();
                        }
                    }
                }
                console.error('åŠ è½½æ–‡ä»¶å¤¹å¤±è´¥:', error);
            } finally {
                isLoadingFolders = false;
                // ç¡®ä¿ä¸Šæ‹‰æç¤ºæ¡æ”¶å›
                const hintEl = document.getElementById('pullUpHint');
                if (hintEl && !isLoadingFolders) { // åªæœ‰åœ¨éåŠ è½½çŠ¶æ€æ‰å¼ºåˆ¶æ”¶å›
                    // å¦‚æœåˆšå¥½åŠ è½½å®Œæœ€åä¸€é¡µï¼Œè®©æç¤ºæ¡æ˜¾ç¤º"æ²¡æœ‰æ›´å¤šäº†"ä¸€ç§’å†æ”¶å›
                    if (hasReachedEnd && append) {
                        const hintText = hintEl.querySelector('.text');
                        if (hintText) hintText.textContent = "å·²åŠ è½½å…¨éƒ¨";
                        setTimeout(() => {
                            hintEl.style.height = '0';
                            hintEl.style.opacity = '0';
                        }, 800);
                    } else {
                        hintEl.style.height = '0';
                        hintEl.style.opacity = '0';
                    }
                    hintEl.classList.remove('rotate');
                }
            }
        }
        
        // æ›´æ–°æ–‡ä»¶å¤¹åˆ†é¡µæ§ä»¶
        function updateFolderPagination() {
            const paginationDiv = document.getElementById('folderPagination');
            if (!paginationDiv) return;
            
            if (totalPages > 1) {
                paginationDiv.style.display = 'flex';
                const prevBtn = document.getElementById('folderPrevPage');
                const nextBtn = document.getElementById('folderNextPage');
                const pageInfo = document.getElementById('folderPageInfo');
                
                if (prevBtn) prevBtn.disabled = currentPage <= 1;
                if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
                if (pageInfo) pageInfo.textContent = `${currentPage} / ${totalPages} (å…± ${totalFolders} ä¸ª)`;
            } else {
                paginationDiv.style.display = 'none';
            }
        }
        
        // åˆ‡æ¢æ–‡ä»¶å¤¹é¡µé¢
        function changeFolderPage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                // ä¿å­˜å½“å‰è·¯å¾„çš„é¡µç 
                folderPageMap[currentFolderPath || ''] = newPage;
                // é‡ç½®åŠ è½½çŠ¶æ€æ ‡å¿—ï¼ˆåˆ‡æ¢é¡µé¢æ—¶é‡ç½®ï¼Œå› ä¸ºå¯èƒ½è¿˜æœ‰æ›´å¤šæ•°æ®ï¼‰
                hasReachedEnd = false;
                consecutiveFailures = 0;
                consecutiveEmptyPages = 0; // é‡ç½®è¿ç»­ç©ºé¡µè®¡æ•°
                loadFolders(currentFolderPath || '', newPage, null, false);
            }
        }
        
        // ==================== æ€§èƒ½ä¼˜åŒ–ï¼šIntersectionObserver ====================
        // ç”¨äºæ‡’åŠ è½½å›¾ç‰‡å’Œç¼©ç•¥å›¾ï¼Œåªæœ‰å‡ºç°åœ¨å±å¹•é‡Œæ‰åŠ è½½
        // ==================== æ ¸å¿ƒä¼˜åŒ–ï¼šå›¾ç‰‡æ‡’åŠ è½½ç®¡ç†å™¨ ====================
        
        // åˆå§‹åŒ–å›¾ç‰‡è§‚å¯Ÿå™¨
        function initImageObserver() {
            // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
            if (mainImageObserver) {
                mainImageObserver.disconnect();
            }

            // åˆ›å»ºæ–°çš„è§‚å¯Ÿå™¨
            const imageViewer = document.getElementById('imageViewer');
            if (!imageViewer || !('IntersectionObserver' in window)) {
                return;
            }

            mainImageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    // å½“å›¾ç‰‡è¿›å…¥è§†å£ï¼ˆæˆ–è€…æ¥è¿‘è§†å£ï¼‰æ—¶
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const realSrc = img.getAttribute('data-src');
                        
                        if (realSrc) {
                            // åªè¦å¼€å§‹åŠ è½½äº†ï¼Œå°±åœæ­¢è§‚å¯Ÿå®ƒï¼ˆé¿å…é‡å¤è§¦å‘ï¼‰
                            observer.unobserve(img);
                            
                            // å¼€å§‹åŠ è½½å›¾ç‰‡
                            img.src = realSrc;
                            
                            // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²ç»åŠ è½½å®Œæˆï¼ˆå¯èƒ½åœ¨ç¼“å­˜ä¸­ï¼‰
                            if (img.complete && img.naturalHeight !== 0) {
                                // å›¾ç‰‡å·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œç«‹å³æ˜¾ç¤º
                                img.classList.add('loaded');
                                img.removeAttribute('data-src');
                            } else {
                                // åŠ è½½å®Œæˆåç§»é™¤ data-src æ ‡è®°ï¼Œæ·»åŠ  loaded ç±»
                                img.onload = () => {
                                    img.classList.add('loaded');
                                    img.removeAttribute('data-src'); 
                                };
                                
                                // åŠ è½½å¤±è´¥å¤„ç†
                                img.onerror = () => {
                                    // åŠ è½½å¤±è´¥æ—¶ï¼Œç§»é™¤å ä½å›¾ï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                                    img.style.display = 'none';
                                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', realSrc);
                                };
                            }
                        }
                    }
                });
            }, {
                root: imageViewer, // ç›‘è§†å®¹å™¨
                rootMargin: '1000px 0px', // å…³é”®é…ç½®ï¼šæå‰1000pxåŠ è½½ï¼ˆä»500pxå¢åŠ åˆ°1000pxï¼‰ï¼Œæå‰åŠ è½½æ›´å¤š
                threshold: 0.01 // åªè¦éœ²å‡º1%å°±è§¦å‘
            });
        }
        
        // ==================== ä¿®å¤ï¼šç²¾å‡†é¡µç è®¡æ•°å™¨ ====================
        function initPageCounterObserver() {
            const viewer = document.getElementById('imageViewer');
            
            // å…ˆé”€æ¯æ—§çš„
            if (pageCounterObserver) {
                pageCounterObserver.disconnect();
            }
            
            if (!viewer || !('IntersectionObserver' in window)) {
                return;
            }

            const options = {
                root: viewer,
                // â˜…â˜…â˜… æ ¸å¿ƒé­”æ³•ï¼šå°†æ£€æµ‹åŒºåŸŸç¼©å°ä¸ºå±å¹•ä¸­é—´çš„ä¸€æ¡çº¿ â˜…â˜…â˜…
                // '-50% 0px -50% 0px' æ„å‘³ç€ä¸Šä¸‹å„ç¼©å‡50%ï¼Œåªå‰©ä¸­é—´
                rootMargin: '-50% 0px -50% 0px', 
                threshold: 0
            };

            pageCounterObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // åªæœ‰å½“å›¾ç‰‡ç©¿è¿‡å±å¹•ä¸­å¿ƒçº¿æ—¶ï¼Œæ‰æ›´æ–°é¡µç 
                        const index = parseInt(entry.target.dataset.index);
                        if (!isNaN(index)) {
                            // æ›´æ–°å…¨å±€ currentIndexï¼Œä¿è¯åç»­æ“ä½œï¼ˆå¦‚åˆ·æ–°ï¼‰èƒ½è®°ä½ä½ç½®
                            currentIndex = index; 
                            updateUI();
                        }
                    }
                });
            }, options);
        }
        
        // åˆå§‹åŒ–ç¼©ç•¥å›¾è§‚å¯Ÿå™¨
        function setupObservers() {
            // ç¼©ç•¥å›¾è§‚å¯Ÿå™¨
            if ('IntersectionObserver' in window) {
                const folderBrowser = document.getElementById('folderBrowser');
                if (folderBrowser) {
                    thumbnailObserver = new IntersectionObserver((entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                const src = img.getAttribute('data-src');
                                if (src) {
                                    img.src = src;
                                    img.removeAttribute('data-src');
                                    // åŠ è½½å®Œæˆåæ·¡å…¥
                                    img.onload = () => {
                                        img.classList.add('loaded');
                                    };
                                    observer.unobserve(img);
                                }
                            }
                        });
                    }, { root: folderBrowser, rootMargin: '100px' });
                }
            }
        }

        // ==================== äº¤äº’ä¼˜åŒ–ï¼šæ‰‹åŠ¿ä¸Šæ‹‰åŠ è½½ (ä¿®å¤æ— é™åŠ è½½Bug) ====================
        function setupPullUpToLoad() {
            const folderBrowser = document.getElementById('folderBrowser');
            const hintEl = document.getElementById('pullUpHint');
            if (!folderBrowser || !hintEl) return;
            
            const hintText = hintEl.querySelector('.text');
            const hintIcon = hintEl.querySelector('.icon');
            
            let startY = 0;
            let isDragging = false;
            let isAtBottom = false;
            const THRESHOLD = 60; // è§¦å‘é˜ˆå€¼
            const MAX_DRAG = 200; // æœ€å¤§æ‹–æ‹½è·ç¦»

            folderBrowser.addEventListener('touchstart', (e) => {
                const scrollTop = folderBrowser.scrollTop;
                const scrollHeight = folderBrowser.scrollHeight;
                const clientHeight = folderBrowser.clientHeight;
                
                // åªæœ‰ç¡®åˆ‡æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆè¯¯å·®å…è®¸ 2pxï¼‰æ‰å…è®¸è§¦å‘ä¸Šæ‹‰
                if (scrollHeight - scrollTop - clientHeight <= 2) {
                    isAtBottom = true;
                    startY = e.touches[0].clientY;
                } else {
                    isAtBottom = false;
                }
            }, { passive: true });

            folderBrowser.addEventListener('touchmove', (e) => {
                // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œæˆ–è€…æ˜¯æ²¡åˆ°åº•éƒ¨ï¼Œæˆ–è€…æ˜¯å·²ç»æ ‡è®°ä¸ºåˆ°åº•äº†ï¼Œå°±ä¸å¤„ç†
                if (!isAtBottom || isLoadingFolders) return;

                const currentY = e.touches[0].clientY;
                const deltaY = startY - currentY; 

                // åªæœ‰å‘ä¸Šæ‹‰ (deltaY > 0)
                if (deltaY > 0) {
                    isDragging = true;
                    
                    // é˜»å°¼æ•ˆæœ
                    const moveDistance = Math.min(deltaY * 0.4, MAX_DRAG); 
                    
                    hintEl.style.height = `${moveDistance}px`;
                    hintEl.style.opacity = Math.min(moveDistance / THRESHOLD, 1);

                    // --- å…³é”®ä¿®æ”¹ï¼šåœ¨è¿™é‡Œå°±åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µï¼Œæ”¹å˜æç¤ºæ–‡å­— ---
                    if (currentPage >= totalPages) {
                        hintText.textContent = "åˆ°åº•äº† (æ¾æ‰‹å›å¼¹)";
                        hintEl.classList.remove('rotate');
                        // å¦‚æœå·²ç»åˆ°åº•ï¼Œä¸å…è®¸æ‹‰å¤ªé•¿ï¼Œç»™ç”¨æˆ·ä¸€ç§"æ‹‰ä¸åŠ¨"çš„æ„Ÿè§‰
                        if (moveDistance > 60) hintEl.style.height = '60px'; 
                    } else {
                        if (moveDistance > THRESHOLD) {
                            hintText.textContent = "é‡Šæ”¾ç«‹å³åŠ è½½";
                            hintEl.classList.add('rotate'); 
                        } else {
                            hintText.textContent = "ä¸Šæ‹‰åŠ è½½æ›´å¤š";
                            hintEl.classList.remove('rotate');
                        }
                    }
                }
            }, { passive: true });

            folderBrowser.addEventListener('touchend', async (e) => {
                if (!isDragging) return;
                
                const currentHeight = parseFloat(hintEl.style.height || 0);
                isDragging = false;
                isAtBottom = false;

                // --- æ ¸å¿ƒä¿®å¤é€»è¾‘ ---
                
                // 1. å¦‚æœå·²ç»åˆ°è¾¾æœ€åä¸€é¡µï¼Œæˆ–è€…å·²ç»æ˜¯ç»“æŸçŠ¶æ€
                if (currentPage >= totalPages || hasReachedEnd) {
                    hintText.textContent = "æ²¡æœ‰æ›´å¤šäº†";
                    // ä¿æŒä¸€å°ä¼šå„¿æç¤ºï¼Œç„¶åæ”¶å›
                    setTimeout(() => {
                        hintEl.style.height = '0';
                        hintEl.style.opacity = '0';
                    }, 800);
                    return; // ã€ç»å¯¹åœæ­¢æ‰§è¡Œã€‘
                }

                // 2. åªæœ‰é«˜åº¦è¶…è¿‡é˜ˆå€¼æ—¶æ‰å¤„ç†
                if (currentHeight > THRESHOLD) {
                    // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µæ•°æ®æœªåŠ è½½
                    const hasMorePages = currentPage < totalPages;
                    
                    if (hasMorePages) {
                        // æƒ…æ™¯ 1ï¼šå¦‚æœè¿˜æœ‰ä¸‹ä¸€é¡µï¼Œä¼˜å…ˆåŠ è½½ä¸‹ä¸€é¡µï¼Œè€Œä¸æ˜¯è·³è½¬
                        if (navigator.vibrate) navigator.vibrate(20); // è½»å¾®éœ‡åŠ¨åé¦ˆ
                        
                        hintText.textContent = "åŠ è½½ä¸‹ä¸€é¡µä¸­...";
                        hintEl.style.height = '40px'; 
                        
                        const nextPage = currentPage + 1;
                        folderPageMap[currentFolderPath || ''] = nextPage;
                        await loadFolders(currentFolderPath || '', nextPage, null, true);
                    } else {
                        // æƒ…æ™¯ 2ï¼šç¡®å®å·²ç»åˆ°åº•äº†ï¼ˆæ²¡æœ‰æ›´å¤šé¡µï¼‰ï¼Œæ‰å…è®¸è·³è½¬ä¸‹ä¸€è¯
                        if (navigator.vibrate) navigator.vibrate(50); // å¼ºçƒˆéœ‡åŠ¨åé¦ˆ
                        hintText.textContent = "è·³è½¬ä¸‹ä¸€è¯...";
                        hintEl.style.height = '40px';
                        // è·³è½¬ä¸‹ä¸€è¯
                        jumpToSiblingFolder(1);
                    }
                } else {
                    // æ²¡æœ‰æ‹‰å¤Ÿè·ç¦»ï¼Œç›´æ¥å›å¼¹
                    hintEl.style.height = '0';
                    hintEl.style.opacity = '0';
                }
                
                hintEl.classList.remove('rotate');
            });
        }

        // ==================== æ ¸å¿ƒé€»è¾‘ï¼šè·³è½¬å…„å¼Ÿæ–‡ä»¶å¤¹ ====================
        let isJumpingChapter = false;

        async function jumpToSiblingFolder(direction) {
            // direction: -1 (ä¸Šä¸€è¯), 1 (ä¸‹ä¸€è¯)
            if (!currentFolderPath || isJumpingChapter) return;
            
            // è·å–å½“å‰æ–‡ä»¶å¤¹çš„çˆ¶è·¯å¾„
            const parts = currentFolderPath.split('/').filter(p => p);
            const currentFolderName = parts.pop(); // å–å‡ºå½“å‰æ–‡ä»¶å¤¹å
            const parentPath = parts.join('/'); // å‰©ä¸‹çš„å°±æ˜¯çˆ¶è·¯å¾„

            isJumpingChapter = true;
            showToast(direction === 1 ? "æ­£åœ¨å¯»æ‰¾ä¸‹ä¸€è¯..." : "æ­£åœ¨å¯»æ‰¾ä¸Šä¸€è¯...");

            try {
                // è·å–çˆ¶ç›®å½•åˆ—è¡¨ä»¥ç¡®å®šé¡ºåº
                const [sortBy, order] = currentSort.split('-');
                const comicDirParam = currentComicDir ? `&comic_dir=${encodeURIComponent(currentComicDir)}` : '';
                // è·å–åˆ—è¡¨ï¼ˆæš‚ä¸åˆ†é¡µä»¥ç¡®ä¿èƒ½æ‰¾åˆ°ç›¸é‚»æ–‡ä»¶å¤¹ï¼‰
                const url = `${CONFIG.API_BASE_URL}/api/files?path=${encodeURIComponent(parentPath)}&sort_by=${sortBy}&order=${order}&page=1&page_size=1000${comicDirParam}`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.items) {
                    const folders = data.items.filter(item => item.type === 'directory');
                    const currentIndex = folders.findIndex(f => f.name === currentFolderName);
                    
                    if (currentIndex !== -1) {
                        const targetIndex = currentIndex + direction;
                        
                        if (targetIndex >= 0 && targetIndex < folders.length) {
                            const targetFolder = folders[targetIndex];
                            showToast(`å³å°†è·³è½¬: ${targetFolder.name}`);
                            
                            // è·³è½¬å‰ï¼Œä¸é€€å‡ºé˜…è¯»æ¨¡å¼ï¼Œé˜²æ­¢é—ªçƒ
                            // æˆ‘ä»¬ç›´æ¥è°ƒç”¨ navigateToFolderï¼Œå®ƒå†…éƒ¨ä¼šå¤„ç†
                            await navigateToFolder(targetFolder.path);
                            
                        } else {
                            showToast(direction === 1 ? "å·²ç»æ˜¯æœ€åä¸€è¯äº†" : "å·²ç»æ˜¯ç¬¬ä¸€è¯äº†");
                        }
                    } else {
                        showToast("æ— æ³•å®šä½å½“å‰ç« èŠ‚");
                    }
                }
            } catch (e) {
                console.error(e);
                showToast("è·³è½¬å¤±è´¥");
            } finally {
                isJumpingChapter = false;
            }
        }

        // ç®€å•æç¤ºå·¥å…·
        function showToast(msg) {
            const toast = document.createElement('div');
            toast.style.cssText = "position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); color:white; padding:12px 24px; border-radius:8px; z-index:3000; font-size:14px; transition: opacity 0.3s;";
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 1500);
        }

        // ==================== äº¤äº’ï¼šé•¿æŒ‰è·³è½¬ä¸åº•éƒ¨ä¸Šæ‹‰è·³è½¬ ====================
        function setupImageViewerInteractions() {
            const viewer = document.getElementById('imageViewer');
            const overlay = document.getElementById('longPressOverlay');
            if (!viewer || !overlay) return;
            
            const icon = overlay.querySelector('.icon');
            const text = overlay.querySelector('.text');
            
            let touchTimer = null;
            let touchStartX = 0;
            let touchStartY = 0;
            let isLongPress = false;
            const LONG_PRESS_DELAY = 500; // 500ms è§¦å‘é•¿æŒ‰

            let pullStartY = 0;
            let isPullingUp = false;
            let maxPullDistance = 0;

            // --- 1. è§¦æ‘¸å¼€å§‹ ---
            viewer.addEventListener('touchstart', (e) => {
                if (e.touches.length !== 1) return;
                
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                
                // A. é•¿æŒ‰æ£€æµ‹åˆå§‹åŒ–
                const screenWidth = window.innerWidth;
                let direction = 0; 
                if (touchStartX < screenWidth * 0.25) direction = -1; // å·¦è¾¹ 25%
                else if (touchStartX > screenWidth * 0.75) direction = 1; // å³è¾¹ 25%

                if (direction !== 0) {
                    touchTimer = setTimeout(() => {
                        isLongPress = true;
                        overlay.className = `long-press-overlay active ${direction === 1 ? 'long-press-right' : 'long-press-left'}`;
                        icon.textContent = direction === 1 ? 'â­' : 'â®';
                        text.textContent = direction === 1 ? 'æ¾æ‰‹è·³è½¬ä¸‹ä¸€è¯' : 'æ¾æ‰‹è·³è½¬ä¸Šä¸€è¯';
                        if (navigator.vibrate) navigator.vibrate(50);
                    }, LONG_PRESS_DELAY);
                }
                
                // B. ä¸Šæ‹‰æ£€æµ‹åˆå§‹åŒ– (æ”¾å®½åˆ¤å®šæ¡ä»¶ï¼šè¯¯å·® 10px)
                const isAtBottom = Math.ceil(viewer.scrollTop) + viewer.clientHeight >= viewer.scrollHeight - 10;
                if (isAtBottom) {
                    isPullingUp = true;
                    pullStartY = e.touches[0].clientY;
                    maxPullDistance = 0;
                } else {
                    isPullingUp = false;
                }
            }, { passive: true });

            // --- 2. è§¦æ‘¸ç§»åŠ¨ ---
            viewer.addEventListener('touchmove', (e) => {
                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;

                // A. ç§»åŠ¨è¶…è¿‡ 10px å–æ¶ˆé•¿æŒ‰
                if (Math.abs(currentX - touchStartX) > 10 || Math.abs(currentY - touchStartY) > 10) {
                    clearTimeout(touchTimer);
                    if (isLongPress) {
                        overlay.className = 'long-press-overlay';
                        isLongPress = false;
                    }
                }
                
                // B. å¤„ç†ä¸Šæ‹‰åŠ¨ç”»
                if (isPullingUp) {
                    const deltaY = pullStartY - currentY; // å‘ä¸Šæ‹‰ deltaY > 0
                    if (deltaY > 0) {
                        maxPullDistance = deltaY;
                        // è·å–åº•éƒ¨çš„æç¤ºå…ƒç´  (å®ƒæ˜¯åœ¨ renderAllImages é‡ŒåŠ¨æ€ç”Ÿæˆçš„)
                        const hintContainer = document.querySelector('.next-chapter-hint');
                        const hintText = document.querySelector('.next-chapter-hint span');
                        
                        if (hintContainer && hintText) {
                            // é˜»å°¼ç§»åŠ¨
                            const visualPull = Math.min(deltaY * 0.4, 150);
                            hintContainer.style.transform = `translateY(-${visualPull}px)`;
                            hintContainer.style.transition = 'none'; // æ‹–åŠ¨æ—¶æ— è¿‡æ¸¡

                            if (deltaY > 80) {
                                hintText.textContent = "â¬†ï¸ é‡Šæ”¾è·³è½¬ä¸‹ä¸€è¯";
                                hintText.style.color = "#667eea";
                                hintText.style.fontWeight = "bold";
                            } else {
                                hintText.innerHTML = "ç»§ç»­ä¸Šæ‹‰è·³è½¬ä¸‹ä¸€è¯ <br> (æˆ–é•¿æŒ‰å³ä¾§åŒºåŸŸ)";
                                hintText.style.color = "#666";
                                hintText.style.fontWeight = "normal";
                            }
                        }
                    }
                }
            }, { passive: true });

            // --- 3. è§¦æ‘¸ç»“æŸ ---
            viewer.addEventListener('touchend', (e) => {
                clearTimeout(touchTimer);
                
                // A. è§¦å‘é•¿æŒ‰è·³è½¬
                if (isLongPress) {
                    const screenWidth = window.innerWidth;
                    if (touchStartX > screenWidth * 0.75) jumpToSiblingFolder(1);
                    else if (touchStartX < screenWidth * 0.25) jumpToSiblingFolder(-1);
                    
                    overlay.className = 'long-press-overlay';
                    isLongPress = false;
                    e.preventDefault(); // é˜²æ­¢è§¦å‘ç‚¹å‡»
                    return;
                }
                
                // B. è§¦å‘ä¸Šæ‹‰è·³è½¬
                if (isPullingUp) {
                    isPullingUp = false;
                    const hintContainer = document.querySelector('.next-chapter-hint');
                    const hintText = document.querySelector('.next-chapter-hint span');
                    
                    // æ ·å¼å›å¼¹
                    if (hintContainer) {
                        hintContainer.style.transform = 'translateY(0)';
                        hintContainer.style.transition = 'transform 0.3s ease';
                    }
                    if (hintText) {
                        hintText.innerHTML = "ç»§ç»­ä¸Šæ‹‰è·³è½¬ä¸‹ä¸€è¯ <br> (æˆ–é•¿æŒ‰å³ä¾§åŒºåŸŸ)";
                        hintText.style.color = "#666";
                        hintText.style.fontWeight = "normal";
                    }

                    // é˜ˆå€¼åˆ¤æ–­
                    if (maxPullDistance > 80) {
                        // åªæœ‰å½“å›¾ç‰‡çœŸçš„åŠ è½½å®Œäº†ï¼ˆæˆ–è€…å½“å‰æ˜¯æœ€åä¸€é¡µï¼‰æ‰è·³è½¬
                        // ç”±äºæˆ‘ä»¬åœ¨ loadFolderImages ä¸­å·²ç»ä¸€æ¬¡æ€§åŠ è½½äº†æ‰€æœ‰å›¾ç‰‡ï¼Œè¿™é‡Œç›´æ¥è·³è½¬é€šå¸¸æ˜¯æ²¡é—®é¢˜çš„ã€‚
                        // ä½†ä¸ºäº†é€»è¾‘ä¸¥è°¨ï¼Œç¡®ä¿ä¸æ˜¯åœ¨åŠ è½½ä¸­
                        if (!isLoadingImages) {
                            if (navigator.vibrate) navigator.vibrate(50);
                            jumpToSiblingFolder(1); // ä¸‹ä¸€è¯
                        }
                    }
                }
            });
        }
        // æ›´æ–°æ–‡ä»¶å¤¹é¢åŒ…å±‘
        function updateFolderBreadcrumb(path) {
            const breadcrumb = document.getElementById('folderBreadcrumb');
            if (!path) {
                breadcrumb.innerHTML = '<div class="breadcrumb-item"><span class="breadcrumb-current">ğŸ“ æ ¹ç›®å½•</span></div>';
                return;
            }
            
            const parts = path.split('/').filter(p => p);
            let html = '<div class="breadcrumb-item"><span class="breadcrumb-link" onclick="navigateToFolder(\'\')">ğŸ“ æ ¹ç›®å½•</span></div>';
            let current = '';
            
            parts.forEach((part, index) => {
                current += (current ? '/' : '') + part;
                const isLast = index === parts.length - 1;
                // è·¯å¾„è½¬ä¹‰ï¼ˆç”¨äº JS å‚æ•°ï¼‰
                const jsPath = current.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                // HTML å†…å®¹è½¬ä¹‰
                const safeName = escapeHtml(part);
                
                html += `<div class="breadcrumb-item">`;
                html += `<span class="breadcrumb-separator">â€º</span>`;
                if (isLast) {
                    html += `<span class="breadcrumb-current">${safeName}</span>`;
                } else {
                    html += `<span class="breadcrumb-link" onclick="navigateToFolder('${jsPath}')">${safeName}</span>`;
                }
                html += `</div>`;
            });
            
            breadcrumb.innerHTML = html;
        }

        // å¯¼èˆªåˆ°æ–‡ä»¶å¤¹
        async function navigateToFolder(path, addToHistory = true) {
            // â˜…â˜…â˜… æ ¸å¿ƒï¼šåªè¦åˆ‡ç›®å½•ï¼Œå…ˆé€€é˜…è¯»å™¨å›åˆ°åˆ—è¡¨ â˜…â˜…â˜…
            exitMobileReader();
            
            // 1. ç«‹å³æ¸…ç†æ—§çš„å›¾ç‰‡å’ŒåŠ è½½ä»»åŠ¡ï¼ˆå…³é”®ï¼šé˜²æ­¢è¿”å›ä¸Šçº§åä¾æ—§åŠ è½½ï¼‰
            if (path !== currentFolderPath) {
                clearImageViewer(); 
            }
            
            // --- History API ä¼˜åŒ–å¼€å§‹ ---
            if (addToHistory && path !== currentFolderPath) {
                const url = path ? `?folder=${encodeURIComponent(path)}` : window.location.pathname;
                history.pushState({ folder: path }, '', url);
            }
            // --- History API ä¼˜åŒ–ç»“æŸ ---
            
            currentFolderPath = path;
            // è·å–è¯¥è·¯å¾„ä¿å­˜çš„é¡µç ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç¬¬ä¸€é¡µ
            const savedPage = folderPageMap[path || ''] || 1;
            currentPage = savedPage;
            // é‡ç½®åŠ è½½çŠ¶æ€æ ‡å¿—
            hasReachedEnd = false; // é‡ç½®åˆ°åº•æ ‡å¿—
            totalPages = 1;        // é‡ç½®æ€»é¡µæ•°ï¼Œé˜²æ­¢è¢«ä¸Šä¸€ä¸ªæ–‡ä»¶å¤¹çš„æ€»é¡µæ•°è¯¯å¯¼
            consecutiveFailures = 0;
            
            // å¦‚æœæ˜¯æ ¹ç›®å½•ï¼Œæ¸…ç©ºå›¾ç‰‡
            if (!path) {
                currentImages = [];
                currentIndex = -1;
                // æ¸…ç©ºå›¾ç‰‡åˆ—è¡¨æ˜¾ç¤º
                const imageList = document.getElementById('imageList');
                const imageListTitle = document.getElementById('imageListTitle');
                imageList.classList.remove('has-images');
                imageListTitle.style.display = 'none';
                imageList.innerHTML = '';
            }
            
            // æ³¨æ„ï¼šè¿™é‡Œä¸è¦å† push folderHistory äº†ï¼Œæˆ‘ä»¬æ”¹ç”¨æµè§ˆå™¨åŸç”Ÿ History
            // folderHistory.push(path); // åˆ é™¤è¿™è¡Œ
            
            await loadFolders(path, savedPage);
            // åªåœ¨éæ ¹ç›®å½•æ—¶è‡ªåŠ¨åŠ è½½å›¾ç‰‡
            if (path) {
                await loadFolderImages(path);
            }
            updateNavButtons();
        }
        
        // é‡æ–°åŠ è½½å½“å‰æ–‡ä»¶å¤¹ï¼ˆç”¨äºå¼ºåˆ¶åˆ·æ–°ï¼‰
        async function reloadCurrentFolder() {
            if (!currentFolderPath) {
                await loadFolders('', currentPage);
            } else {
                await loadFolders(currentFolderPath);
                if (currentImages.length > 0) {
                    await loadFolderImages(currentFolderPath);
                }
            }
        }

        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        function scrollToTop(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // æ ¹æ®å½“å‰è§†å›¾çŠ¶æ€æ»šåŠ¨æ­£ç¡®çš„å®¹å™¨
            if (document.body.classList.contains('mobile-reader-active')) {
                // ç§»åŠ¨ç«¯é˜…è¯»å™¨æ¨¡å¼ï¼šæ»šåŠ¨å›¾ç‰‡æŸ¥çœ‹å™¨
                const imageViewer = document.getElementById('imageViewer');
                if (imageViewer) {
                    imageViewer.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } else {
                // åˆ—è¡¨æ¨¡å¼ï¼šæ»šåŠ¨æ–‡ä»¶å¤¹æµè§ˆå™¨
                const folderBrowser = document.getElementById('folderBrowser');
                if (folderBrowser) {
                    folderBrowser.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        }

        // è¿”å›ä¸Šå±‚æ–‡ä»¶å¤¹
        async function goToParentFolder(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            if (!currentFolderPath) return;
            
            const parts = currentFolderPath.split('/').filter(p => p);
            if (parts.length === 0) return;
            
            parts.pop();
            const parentPath = parts.join('/');
            await navigateToFolder(parentPath);
            
            // æ»šåŠ¨åˆ°æ–‡ä»¶å¤¹æµè§ˆå™¨é¡¶éƒ¨
            const folderBrowser = document.getElementById('folderBrowser');
            if (folderBrowser) {
                folderBrowser.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª—
        function showModal(title, message, buttons) {
            const overlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalButtons = document.getElementById('modalButtons');
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `modal-btn ${btn.class || 'modal-btn-secondary'}`;
                button.textContent = btn.text;
                button.onclick = () => {
                    overlay.classList.remove('show');
                    if (btn.onClick) {
                        btn.onClick();
                    }
                };
                modalButtons.appendChild(button);
            });
            
            overlay.classList.add('show');
        }
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
        function closeModalOnOverlay(event) {
            if (event.target.id === 'modalOverlay') {
                document.getElementById('modalOverlay').classList.remove('show');
            }
        }
        
        // åˆ é™¤æ–‡ä»¶å¤¹
        async function deleteFolder(folderPath, folderName) {
            showModal(
                'ç¡®è®¤åˆ é™¤',
                `ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ "${folderName}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ–‡ä»¶å¤¹åŠå…¶æ‰€æœ‰å†…å®¹ï¼Œæ— æ³•æ¢å¤ï¼`,
                [
                    {
                        text: 'å–æ¶ˆ',
                        class: 'modal-btn-secondary',
                        onClick: null
                    },
                    {
                        text: 'ç¡®è®¤åˆ é™¤',
                        class: 'modal-btn-danger',
                        onClick: async () => {
                            try {
                                const response = await fetch(`${CONFIG.API_BASE_URL}/api/files?path=${encodeURIComponent(folderPath)}`, {
                                    method: 'DELETE'
                                });
                                
                                const data = await response.json();
                                
                                if (response.ok && data.success) {
                                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ–‡ä»¶å¤¹ï¼Œè¿”å›ä¸Šä¸€çº§
                                    if (currentFolderPath === folderPath || currentFolderPath.startsWith(folderPath + '/')) {
                                        const parts = currentFolderPath.split('/').filter(p => p);
                                        if (parts.length > 0 && parts[0] === folderPath.split('/')[0]) {
                                            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ–‡ä»¶å¤¹æˆ–å…¶çˆ¶æ–‡ä»¶å¤¹ï¼Œè¿”å›æ ¹ç›®å½•
                                            currentPage = 1;
                                            await navigateToFolder('');
                                        } else {
                                            // è¿”å›ä¸Šä¸€çº§
                                            await goToParentFolder(null);
                                        }
                                    } else {
                                        // é‡æ–°åŠ è½½å½“å‰æ–‡ä»¶å¤¹åˆ—è¡¨
                                        if (!currentFolderPath) {
                                            await loadFolders('', currentPage);
                                        } else {
                                            await loadFolders(currentFolderPath);
                                        }
                                    }
                                } else {
                                    showModal('åˆ é™¤å¤±è´¥', 'åˆ é™¤æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', [
                                        { text: 'ç¡®å®š', class: 'modal-btn-primary', onClick: null }
                                    ]);
                                }
                            } catch (error) {
                                showModal('åˆ é™¤å¤±è´¥', 'åˆ é™¤æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', [
                                    { text: 'ç¡®å®š', class: 'modal-btn-primary', onClick: null }
                                ]);
                                console.error('åˆ é™¤æ–‡ä»¶å¤¹å¤±è´¥:', error);
                            }
                        }
                    }
                ]
            );
        }

        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateNavButtons() {
            const goUpBtn = document.getElementById('goUpBtn');
            const goRootBtn = document.getElementById('goRootBtn');
            
            // è¿”å›é¡¶éƒ¨æŒ‰é’®å§‹ç»ˆå¯ç”¨
            if (goUpBtn) {
                goUpBtn.disabled = false;
            }
            // è¿”å›ä¸Šä¸€å±‚çº§æŒ‰é’®ï¼šåœ¨æ ¹ç›®å½•æ—¶ç¦ç”¨ï¼ˆå¦‚æœæŒ‰é’®å­˜åœ¨ï¼‰
            if (goRootBtn) {
                goRootBtn.disabled = !currentFolderPath;
            }
        }

        // åŠ è½½æ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡
        async function loadFolderImages(folderPath, cacheBuster = null) {
            currentFolderPath = folderPath;
            currentImages = [];
            currentIndex = -1;
            
            const imageList = document.getElementById('imageList');
            const imageListTitle = document.getElementById('imageListTitle');
            
            // å…ˆéšè—å›¾ç‰‡åˆ—è¡¨å’Œæ ‡é¢˜
            imageList.classList.remove('has-images');
            imageListTitle.style.display = 'none';
            imageList.innerHTML = '';
            
            try {
                // æ·»åŠ å¼ºåˆ¶åˆ·æ–°å‚æ•°ï¼ˆç»•è¿‡ç¼“å­˜ï¼‰
                const cacheParam = cacheBuster ? `&_t=${cacheBuster}` : '';
                const comicDirParam = currentComicDir ? `&comic_dir=${encodeURIComponent(currentComicDir)}` : '';
                // çœ‹æ¼«ç”»æ—¶ï¼Œé»˜è®¤æŒ‰æ–‡ä»¶åå‡åºæ’åº
                // æ˜¾å¼å¢åŠ  &page=1&page_size=5000ï¼Œç¡®ä¿åŠ è½½å®Œæœ¬è¯æ‰€æœ‰å›¾ç‰‡
                const url = `${CONFIG.API_BASE_URL}/api/files?path=${encodeURIComponent(folderPath)}&sort_by=name&order=asc&page=1&page_size=5000${comicDirParam}${cacheParam}`;
                
                // ä½¿ç”¨ no-cache é€‰é¡¹å¼ºåˆ¶è·å–æœ€æ–°æ•°æ®
                const fetchOptions = cacheBuster ? {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                } : {};
                
                const response = await fetch(url, fetchOptions);
                const data = await response.json();
                
                if (data.success && data.items) {
                    // è¿‡æ»¤å‡ºå›¾ç‰‡æ–‡ä»¶ï¼ˆåç«¯å·²æŒ‰æ–‡ä»¶åæ’åºï¼Œè¿™é‡Œåªéœ€è¦è¿‡æ»¤ï¼‰
                    currentImages = data.items
                        .filter(item => {
                            // è·³è¿‡ç›®å½•
                            if (item.type === 'directory') return false;
                            // æå–æ–‡ä»¶æ‰©å±•å
                            const lastDotIndex = item.name.lastIndexOf('.');
                            if (lastDotIndex === -1 || lastDotIndex === item.name.length - 1) {
                                return false;
                            }
                            const ext = item.name.toLowerCase().substring(lastDotIndex);
                            return CONFIG.IMAGE_EXTENSIONS.includes(ext);
                        });
                    
                    if (currentImages.length > 0 && folderPath) {
                        // åªåœ¨æœ‰å›¾ç‰‡ä¸”ä¸æ˜¯æ ¹ç›®å½•æ—¶æ¸²æŸ“
                        renderImageList();
                        renderAllImages();
                        currentIndex = 0;
                        showImage(0);
                        // â˜…â˜…â˜… æ ¸å¿ƒï¼šæœ‰å›¾ç‰‡ï¼Œç§»åŠ¨ç«¯è‡ªåŠ¨åˆ‡åˆ°é˜…è¯»å™¨ â˜…â˜…â˜…
                        enterMobileReader();
                        
                        // â˜…â˜…â˜… æ–°å¢ï¼šæ¢å¤è¿›åº¦ â˜…â˜…â˜…
                        const saved = ProgressMgr.get(folderPath);
                        // å¦‚æœæœ‰è®°å½•ï¼Œä¸”è®°å½•çš„é¡µç ä¸æ˜¯ç¬¬ä¸€é¡µ
                        if (saved && saved.page > 0 && saved.page < currentImages.length) {
                            showToast(`æ¢å¤ä¸Šæ¬¡é˜…è¯»ï¼šç¬¬ ${saved.page + 1} é¡µ`);
                            // å»¶è¿Ÿè·³è½¬ï¼Œç­‰å¾…å¸ƒå±€ç¨³å®š
                            setTimeout(() => {
                                showImage(saved.page);
                            }, 100);
                        }
                    } else {
                        // æ²¡æœ‰å›¾ç‰‡æ—¶ï¼Œå®Œå…¨éšè—ï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹
                        clearImageViewer();
                        // æ²¡å›¾ç‰‡ï¼Œç•™åœ¨åˆ—è¡¨é¡µ
                        exitMobileReader();
                    }
                }
            } catch (error) {
                // åŠ è½½å¤±è´¥æ—¶ä¹Ÿéšè—
                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                clearImageViewer();
            }
        }

        // æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨
        function renderImageList() {
            const imageList = document.getElementById('imageList');
            const imageListTitle = document.getElementById('imageListTitle');
            
            if (currentImages.length === 0) {
                imageList.classList.remove('has-images');
                imageListTitle.style.display = 'none';
                return;
            }
            
            imageList.classList.add('has-images');
            imageListTitle.style.display = 'block';
            imageList.innerHTML = '';
            
            currentImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'image-item';
                if (index === currentIndex) {
                    item.classList.add('active');
                }
                item.onclick = () => showImage(index);
                item.title = image.name; // ä¿ç•™æ ‡é¢˜æç¤º
                
                const img = document.createElement('img');
                const comicDirParam = currentComicDir ? `?comic_dir=${encodeURIComponent(currentComicDir)}` : '';
                img.src = `${CONFIG.API_BASE_URL}/api/image/${encodeURIComponent(image.path)}${comicDirParam}`;
                img.alt = image.name;
                img.loading = 'lazy';
                
                item.appendChild(img);
                imageList.appendChild(item);
            });
        }

        // æ˜¾ç¤ºç‰¹å®šå›¾ç‰‡ï¼ˆç‚¹å‡»ä¾§è¾¹æ è·³è½¬ï¼‰
        function showImage(index) {
            if (index < 0 || index >= currentImages.length) return;
            
            currentIndex = index;
            const imageWrapper = document.getElementById('imageWrapper');
            
            // å¦‚æœ DOM ä¸ºç©ºï¼ˆæ¯”å¦‚åˆšä»æ ¹ç›®å½•è¿›æ¥ï¼‰ï¼Œå…ˆæ¸²æŸ“å ä½ç¬¦
            if (imageWrapper.children.length === 0) {
                renderAllImages();
            }
            
            // æ‰¾åˆ°å¯¹åº”çš„å›¾ç‰‡å…ƒç´ 
            const targetImg = imageWrapper.querySelector(`img[data-index="${index}"]`);
            
            if (targetImg) {
                // æ»šåŠ¨åˆ°è¯¥å›¾ç‰‡
                targetImg.scrollIntoView({ behavior: 'auto', block: 'start' });
                
                // å¼ºåˆ¶ç«‹å³åŠ è½½å½“å‰å›¾ç‰‡ï¼ˆä¸éœ€è¦ç­‰è§‚å¯Ÿå™¨è§¦å‘ï¼Œæå‡å“åº”é€Ÿåº¦ï¼‰
                const realSrc = targetImg.getAttribute('data-src');
                if (realSrc) {
                    // è§£é™¤è§‚å¯Ÿ
                    if (mainImageObserver) mainImageObserver.unobserve(targetImg);
                    
                    // å¼€å§‹åŠ è½½
                    targetImg.src = realSrc;
                    targetImg.removeAttribute('data-src');
                    
                    // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²ç»åœ¨ç¼“å­˜ä¸­
                    if (targetImg.complete && targetImg.naturalHeight !== 0) {
                        // å›¾ç‰‡å·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œç«‹å³æ˜¾ç¤º
                        targetImg.classList.add('loaded');
                    } else {
                        // ç­‰å¾…åŠ è½½å®Œæˆ
                        targetImg.onload = () => {
                            targetImg.classList.add('loaded');
                        };
                        // åŠ è½½å¤±è´¥å¤„ç†
                        targetImg.onerror = () => {
                            targetImg.style.display = 'none';
                            console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', realSrc);
                        };
                    }
                }
            }
            
            updateUI();
            renderImageList();
        }
        
        // æ¸²æŸ“æ‰€æœ‰å›¾ç‰‡ï¼ˆåˆ†æ‰¹æŒ‰é¡ºåºåŠ è½½ï¼‰
        function renderAllImages() {
            const imageWrapper = document.getElementById('imageWrapper');
            const loadingText = document.getElementById('loadingText');
            
            // å¦‚æœå½“å‰ä¸åœ¨å›¾ç‰‡æ–‡ä»¶å¤¹æˆ–æ²¡æœ‰å›¾ç‰‡ï¼Œä¸æ¸²æŸ“
            if (!currentFolderPath || currentImages.length === 0) {
                if (imageWrapper) {
                    imageWrapper.innerHTML = '';
                }
                if (loadingText) {
                    loadingText.textContent = 'è¯·ä»å·¦ä¾§é€‰æ‹©å›¾ç‰‡';
                    loadingText.style.display = 'block';
                }
                return;
            }
            
            // 1. åŸºç¡€æ¸…ç†
            if (imageWrapper) imageWrapper.innerHTML = '';
            if (loadingText) loadingText.style.display = 'none';

            // 2. æ£€æŸ¥æ˜¯å¦æœ‰å›¾
            if (!currentFolderPath || currentImages.length === 0) {
                if (loadingText) {
                    loadingText.textContent = 'æ­¤æ–‡ä»¶å¤¹æ²¡æœ‰å›¾ç‰‡';
                    loadingText.style.display = 'block';
                }
                return;
            }

            // 3. ç¡®ä¿è§‚å¯Ÿå™¨å·²åˆå§‹åŒ–
            initImageObserver();
            
            // â˜…â˜…â˜… æ–°å¢ï¼šå¯åŠ¨é¡µç è®¡æ•°å™¨ â˜…â˜…â˜…
            initPageCounterObserver();

            // 4. ç”Ÿæˆ DOM èŠ‚ç‚¹
            const fragment = document.createDocumentFragment(); // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µä¼˜åŒ–æ€§èƒ½
            
            currentImages.forEach((image, index) => {
                const img = document.createElement('img');
                
                // æ„å»ºçœŸå® URL
                const comicDirParam = currentComicDir ? `?comic_dir=${encodeURIComponent(currentComicDir)}` : '';
                const realUrl = `${CONFIG.API_BASE_URL}/api/image/${encodeURIComponent(image.path)}${comicDirParam}`;

                // è®¾ç½®å±æ€§
                img.alt = image.name;
                img.dataset.index = index;
                
                // å…³é”®ï¼šå°†çœŸå®åœ°å€æ”¾åœ¨ data-src ä¸­
                img.setAttribute('data-src', realUrl);
                
                // è®¾ç½®ä¸€ä¸ªé€æ˜åƒç´ ä½œä¸ºåˆå§‹ srcï¼Œé˜²æ­¢æµè§ˆå™¨æ˜¾ç¤º broken image å›¾æ ‡
                img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";

                // é”™è¯¯å¤„ç†
                img.onerror = () => {
                    img.style.display = 'none';
                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', realUrl);
                };
                
                // åŠ å…¥è§‚å¯Ÿé˜Ÿåˆ—
                if (mainImageObserver) {
                    mainImageObserver.observe(img);
                } else {
                    // é™çº§å¤„ç†ï¼šå¦‚æœæ²¡æœ‰è§‚å¯Ÿå™¨ï¼Œç›´æ¥åŠ è½½
                    img.src = realUrl;
                    img.onload = () => {
                        img.classList.add('loaded');
                    };
                }
                
                // â˜…â˜…â˜… æ–°å¢ï¼šåŠ å…¥é¡µç è®¡æ•°è§‚å¯Ÿå™¨ â˜…â˜…â˜…
                if (pageCounterObserver) {
                    pageCounterObserver.observe(img);
                }
                
                fragment.appendChild(img);
            });

            // === æ–°å¢ï¼šæ·»åŠ åº•éƒ¨æç¤ºæ¡ ===
            const endHint = document.createElement('div');
            endHint.className = 'next-chapter-hint';
            endHint.style.display = 'block'; // æ˜¾ç¤ºå‡ºæ¥
            endHint.style.padding = '40px 0';
            endHint.innerHTML = '<span>ç»§ç»­ä¸Šæ‹‰è·³è½¬ä¸‹ä¸€è¯ <br> (æˆ–é•¿æŒ‰å³ä¾§åŒºåŸŸ)</span>';
            fragment.appendChild(endHint);
            // === ç»“æŸæ–°å¢ ===

            imageWrapper.appendChild(fragment);
            
            // 5. æ›´æ–° UI è®¡æ•°å™¨
            updateUI();
        }
        
        // å¼€å§‹æŒ‰é¡ºåºåŠ è½½å›¾ç‰‡
        function startLoadingImages() {
            if (isLoadingImages || imageLoadQueue.length > 0) {
                return; // å·²ç»åœ¨åŠ è½½ä¸­
            }
            
            isLoadingImages = true;
            
            // ç¡®å®šä¼˜å…ˆåŠ è½½çš„å›¾ç‰‡ç´¢å¼•ï¼ˆå½“å‰å›¾ç‰‡åŠå…¶é™„è¿‘ï¼‰
            const priorityIndices = new Set();
            if (currentIndex >= 0) {
                const start = Math.max(0, currentIndex - PRELOAD_RANGE);
                const end = Math.min(currentImages.length - 1, currentIndex + PRELOAD_RANGE);
                for (let i = start; i <= end; i++) {
                    priorityIndices.add(i);
                }
            }
            
            // æ„å»ºåŠ è½½é˜Ÿåˆ—ï¼šä¼˜å…ˆåŠ è½½å½“å‰é™„è¿‘çš„å›¾ç‰‡ï¼Œç„¶åæŒ‰é¡ºåºåŠ è½½å…¶ä»–å›¾ç‰‡
            const allIndices = [];
            for (let i = 0; i < currentImages.length; i++) {
                if (priorityIndices.has(i)) {
                    allIndices.unshift(i); // ä¼˜å…ˆå›¾ç‰‡æ”¾åœ¨å‰é¢
                } else {
                    allIndices.push(i);
                }
            }
            
            // ç§»é™¤é‡å¤ï¼ˆå¦‚æœå½“å‰ç´¢å¼•åœ¨ä¼˜å…ˆåˆ—è¡¨ä¸­ï¼‰
            const uniqueIndices = [];
            const seen = new Set();
            for (const idx of allIndices) {
                if (!seen.has(idx)) {
                    seen.add(idx);
                    uniqueIndices.push(idx);
                }
            }
            
            imageLoadQueue = uniqueIndices;
            loadNextBatch();
        }
        
        // åŠ è½½ä¸‹ä¸€æ‰¹å›¾ç‰‡
        function loadNextBatch() {
            if (imageLoadQueue.length === 0) {
                isLoadingImages = false;
                return;
            }
            
            // å–å‡ºä¸€æ‰¹å›¾ç‰‡ç´¢å¼•
            const batch = imageLoadQueue.splice(0, BATCH_SIZE);
            const imageWrapper = document.getElementById('imageWrapper');
            
            batch.forEach((index) => {
                const img = imageWrapper.querySelector(`img[data-index="${index}"]`);
                if (img && img.dataset.loaded === 'false') {
                    const image = currentImages[index];
                    const comicDirParam = currentComicDir ? `?comic_dir=${encodeURIComponent(currentComicDir)}` : '';
                    img.src = `${CONFIG.API_BASE_URL}/api/image/${encodeURIComponent(image.path)}${comicDirParam}`;
                }
            });
            
            // ç­‰å¾…å½“å‰æ‰¹æ¬¡åŠ è½½å®Œæˆåå†åŠ è½½ä¸‹ä¸€æ‰¹ï¼ˆç»™ä¸€ç‚¹å»¶è¿Ÿé¿å…åŒæ—¶å‘èµ·å¤ªå¤šè¯·æ±‚ï¼‰
            setTimeout(() => {
                loadNextBatch();
            }, 200); // æ¯æ‰¹ä¹‹é—´å»¶è¿Ÿ200ms
        }

        // æ›´æ–°UIçŠ¶æ€
        function updateUI() {
            const counter = document.getElementById('imageCounter');
            counter.textContent = `${currentIndex + 1} / ${currentImages.length}`;
            
            // â˜…â˜…â˜… æ–°å¢ï¼šä¿å­˜è¿›åº¦ â˜…â˜…â˜…
            if (currentFolderPath && currentImages.length > 0) {
                ProgressMgr.save(currentFolderPath, currentIndex, currentImages.length);
            }
        }

        // æ¸…ç©ºå›¾ç‰‡æŸ¥çœ‹å™¨
        // æ¸…ç©ºå›¾ç‰‡æŸ¥çœ‹å™¨å¹¶åœæ­¢åå°åŠ è½½
        function clearImageViewer() {
            const imageWrapper = document.getElementById('imageWrapper');
            const loadingText = document.getElementById('loadingText');
            
            // 1. å…³é”®ï¼šæ–­å¼€è§‚å¯Ÿå™¨ï¼Œåœæ­¢è§¦å‘æ–°çš„ç½‘ç»œè¯·æ±‚
            if (mainImageObserver) {
                mainImageObserver.disconnect();
                mainImageObserver = null;
            }
            
            // æ–­å¼€é¡µç è®¡æ•°å™¨è§‚å¯Ÿå™¨
            if (pageCounterObserver) {
                pageCounterObserver.disconnect();
                pageCounterObserver = null;
            }

            // 2. åœæ­¢å¯èƒ½å­˜åœ¨çš„æ—§å¼åŠ è½½é˜Ÿåˆ—ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
            isLoadingImages = false;
            imageLoadQueue = [];

            // 3. æ¸…ç©º DOM
            if (imageWrapper) {
                // å°† innerHTML æ¸…ç©ºå¯ä»¥ç«‹å³åœæ­¢æµè§ˆå™¨å¯¹æœªå®Œæˆå›¾ç‰‡çš„æ¸²æŸ“å°è¯•
                imageWrapper.innerHTML = '';
            }
            
            // 4. é‡ç½®æç¤ºæ–‡å­—
            if (loadingText) {
                loadingText.textContent = 'è¯·ä»å·¦ä¾§é€‰æ‹©å›¾ç‰‡';
                loadingText.style.display = 'block';
            }
            
            // 5. é‡ç½®è®¡æ•°
            const counter = document.getElementById('imageCounter');
            if (counter) counter.textContent = '0 / 0';
        }

        // åˆ‡æ¢ä¾§è¾¹æ 
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const navButtons = document.getElementById('navButtons');
            sidebar.classList.toggle('hidden');
            // å½“ä¾§è¾¹æ éšè—æ—¶ï¼Œå¯¼èˆªæŒ‰é’®ä¹Ÿéšè—
            if (sidebar.classList.contains('hidden')) {
                navButtons.classList.add('hidden');
            } else {
                navButtons.classList.remove('hidden');
            }
        }

        // å…¨å±
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // è¿”å›é¦–é¡µï¼ˆindexç•Œé¢ï¼‰
        function goToIndex() {
            // è¿”å›é¦–é¡µï¼Œä¿æŒAPIåœ°å€å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const apiParam = urlParams.get('api');
            if (apiParam) {
                window.location.href = `index.html?api=${encodeURIComponent(apiParam)}`;
            } else {
                window.location.href = 'index.html';
            }
        }
        
        // å›åˆ°æ ¹ç›®å½•
        // è¿”å›ä¸Šä¸€å±‚çº§
        async function goToParent() {
            // å¦‚æœå½“å‰åœ¨æ ¹ç›®å½•ï¼Œæ— æ³•è¿”å›ä¸Šä¸€å±‚çº§
            if (!currentFolderPath) {
                return;
            }
            
            // è·å–ä¸Šä¸€å±‚çº§è·¯å¾„
            const pathParts = currentFolderPath.split('/').filter(p => p);
            if (pathParts.length === 0) {
                // å·²ç»åœ¨æ ¹ç›®å½•
                return;
            }
            
            // ç§»é™¤æœ€åä¸€çº§
            pathParts.pop();
            const parentPath = pathParts.join('/');
            
            // å¯¼èˆªåˆ°ä¸Šä¸€å±‚çº§
            await navigateToFolder(parentPath);
        }
        
        async function goToRoot() {
            currentFolderPath = '';
            currentPage = 1;
            // æ¸…ç©ºå›¾ç‰‡åˆ—è¡¨
            currentImages = [];
            currentIndex = -1;
            
            // æ¸…ç©ºå›¾ç‰‡åˆ—è¡¨æ˜¾ç¤º
            const imageList = document.getElementById('imageList');
            const imageListTitle = document.getElementById('imageListTitle');
            imageList.classList.remove('has-images');
            imageListTitle.style.display = 'none';
            imageList.innerHTML = '';
            
            // æ¸…ç©ºä¸»è§†å›¾
            clearImageViewer();
            
            // é‡æ–°åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
            await loadFolders('', 1);
            updateNavButtons();
        }
        
        // å¼ºåˆ¶åˆ·æ–°æ¸…é™¤ç¼“å­˜
        async function forceRefresh() {
            try {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                const folderList = document.getElementById('folderList');
                if (folderList) {
                    folderList.innerHTML = '<div class="loading">æ­£åœ¨æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°...</div>';
                }
                
                // æ¸…é™¤åç«¯ç¼“å­˜
                const clearResponse = await fetch(`${CONFIG.API_BASE_URL}/api/cache/clear`, {
                    method: 'POST',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ç¼“å­˜æ¸…é™¤å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // ç”Ÿæˆæ—¶é—´æˆ³ç”¨äºç»•è¿‡æ‰€æœ‰ç¼“å­˜ï¼ˆåŒ…æ‹¬æµè§ˆå™¨ç¼“å­˜ï¼‰
                const timestamp = Date.now();
                
                // é‡æ–°åŠ è½½å½“å‰æ–‡ä»¶å¤¹åˆ—è¡¨ï¼ˆæ·»åŠ æ—¶é—´æˆ³å‚æ•°ç»•è¿‡ç¼“å­˜ï¼‰
                if (!currentFolderPath) {
                    // æ ¹ç›®å½•ï¼šé‡æ–°åŠ è½½å½“å‰é¡µ
                    await loadFolders('', currentPage, timestamp);
                } else {
                    // å­ç›®å½•ï¼šé‡æ–°åŠ è½½æ–‡ä»¶å¤¹å’Œå›¾ç‰‡
                    await loadFolders(currentFolderPath, undefined, timestamp);
                    // å¦‚æœå½“å‰æœ‰å›¾ç‰‡ï¼Œä¹Ÿé‡æ–°åŠ è½½
                    if (currentImages.length > 0) {
                        await loadFolderImages(currentFolderPath, timestamp);
                    }
                }
            } catch (error) {
                console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
                // å¤±è´¥æ—¶ç›´æ¥åˆ·æ–°é¡µé¢
                window.location.reload();
            }
        }

        
        // é”®ç›˜å¿«æ·é”®
        function setupKeyboard() {
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                
                switch(e.key) {
                    case 'Escape':
                        if (document.fullscreenElement) {
                            document.exitFullscreen();
                        } else if (currentFolderPath) {
                            // æŒ‰ ESC è¿”å›ä¸Šä¸€çº§
                            goToParent();
                        }
                        break;
                    case 'f':
                    case 'F':
                        toggleFullscreen();
                        break;
                    
                    // æ–°å¢ï¼šæ–¹å‘é”®æ§åˆ¶
                    case 'ArrowRight':
                    case 'ArrowDown':
                        // å‘ä¸‹/å‘å³æ»šåŠ¨ä¸€å°æ®µï¼Œæˆ–è€…è·³è½¬åˆ°ä¸‹ä¸€å¼ å›¾
                        // å¦‚æœæ˜¯æ»šåŠ¨æ¨¡å¼ï¼Œå»ºè®®ç›´æ¥ç”¨ scrollBy
                        e.preventDefault();
                        scrollImageViewer(1); 
                        break;
                    case 'ArrowLeft':
                    case 'ArrowUp':
                        e.preventDefault();
                        scrollImageViewer(-1);
                        break;
                    
                    // æ–°å¢ï¼šHome/End
                    case 'Home':
                        e.preventDefault();
                        scrollToTop();
                        break;
                }
            });
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šé”®ç›˜æ»šåŠ¨å›¾ç‰‡è§†å›¾
        function scrollImageViewer(direction) {
            const viewer = document.getElementById('imageViewer');
            if (!viewer) return;
            
            // æ¯æ¬¡æ»šåŠ¨åŠä¸ªå±å¹•é«˜åº¦
            const scrollAmount = window.innerHeight * 0.5 * direction;
            viewer.scrollBy({ top: scrollAmount, behavior: 'smooth' });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>



